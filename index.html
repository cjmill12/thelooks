<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hairstyle Virtual Try-On</title>
    
    <style>
/* --- Global Colors --- */
:root {
    --primary-color: #1D2124; 
    --text-on-dark: #FFFFFF; 
    --background-color: #f4f7f6;
    --text-color: #333; 
    --highlight-color: #28a745; 
    --thumbnail-size: 60px;
    --gallery-gap: 10px; 
    --header-height: 40px;
    --viewport-size-desktop: 300px; 
    --viewport-size-mobile: 250px; 
    --content-max-width: 400px; 
}

body {
    font-family: Arial, sans-serif;
    background-color: var(--background-color);
    color: var(--text-color);
    margin: 0;
    padding: 0; 
    text-align: center;
    -webkit-user-select: none;
    user-select: none;
    overflow-x: hidden; 
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

/* --- Header and Logo Styling (MINIMAL BANNER) --- */
#app-header {
    padding: 0; 
    background-color: #FFFFFF;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); 
    height: var(--header-height); 
    display: flex;
    align-items: center;
    justify-content: center;
    position: sticky; 
    top: 0;
    z-index: 100;
}
#main-logo {
    max-width: 100px !important; 
    height: 35px !important; 
    object-fit: contain; 
}

/* ================================================== */
/* NEW SINGLE-COLUMN LAYOUT */
/* ================================================== */

#main-app-container {
    flex-grow: 1; 
    width: 100%;
    padding: 20px 0;
    margin: 0 auto; 
    display: flex;
    flex-direction: column;
    align-items: center; 
    gap: 15px; 
}

/* --- 1. GENDER BUTTONS (Top Section) --- */
.gender-buttons-container {
    display: flex;
    justify-content: space-between;
    gap: 8px;
    width: 90%; 
    max-width: var(--content-max-width);
    margin-bottom: 0;
    box-sizing: border-box;
    padding: 0 10px;
}

.gender-button {
    flex-grow: 1;
    padding: 10px 15px;
    border: 1px solid #ccc;
    background-color: #f9f9f9;
    color: var(--text-color);
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9em;
    font-weight: bold;
    text-align: center;
    transition: all 0.2s;
    user-select: none;
    line-height: 1;
}

.gender-button:hover {
    background-color: #f0f0f0;
}

.gender-button.selected {
    background-color: var(--primary-color);
    color: var(--text-on-dark);
    border-color: var(--primary-color);
}


/* --- 2. CAMERA SECTION (Middle Section) --- */

#central-section {
    width: 90%;
    max-width: var(--content-max-width);
    display: flex;
    flex-direction: column; 
    align-items: center;
    justify-content: center;
    gap: 15px;
    padding: 0 10px;
}

/* NEW: Horizontal row for viewport and controls */
#camera-and-controls-row {
    display: flex;
    align-items: center; /* Vertically center the items (viewport and controls) */
    justify-content: center; 
    gap: 15px; /* Space between viewport and button column */
    width: 100%;
    max-width: var(--content-max-width);
}

#central-viewport {
    position: relative; 
    width: var(--viewport-size-mobile) !important; 
    height: var(--viewport-size-mobile) !important;
    max-width: var(--viewport-size-desktop) !important; 
    max-height: var(--viewport-size-desktop) !important;
    margin: 0; 
    border-radius: 6px; 
    overflow: hidden;
    background-color: #e0e0e0; 
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
    
    display: flex; 
    align-items: center;
    justify-content: center;
    cursor: pointer; 
    flex-shrink: 0; /* Prevent the viewport from shrinking */
}

/* --- DOTTED HEADSHOT SILHOUETTE STYLES --- */

#camera-placeholder-icon {
    position: relative;
    width: 60%; 
    height: 60%; 
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    /* Dotted Border Style */
    border: 3px dashed #777; 
    border-radius: 6px;
    background-color: #e8e8e8;
}

/* Head (Circle) */
#camera-placeholder-icon::before {
    content: '';
    position: absolute;
    top: 15%; 
    width: 40%;
    height: 40%;
    background-color: #aaa;
    border-radius: 50%;
}

/* Shoulders (Arc) */
#camera-placeholder-icon::after {
    content: '';
    position: absolute;
    bottom: -15%; 
    width: 80%;
    height: 60%;
    background-color: #aaa;
    border-radius: 50% 50% 0 0; 
}

/* --- End Dotted Headshot Silhouette Styles --- */


/* Ensure video and result images fill the viewport */
#video-feed, #ai-result {
    width: 100% !important;
    height: 100% !important; 
    display: block;
    object-fit: cover !important; 
    max-width: 100% !important;
    max-height: 100% !important;
    z-index: 1; 
    display: none; 
}

#status-message {
    position: absolute;
    bottom: 0;
    width: 100%;
    background: rgba(0, 0, 0, 0.6);
    color: white;
    padding: 8px 5px;
    margin: 0;
    font-size: 0.85em;
    text-align: center;
    z-index: 100; 
}

/* CONTROLS (holds the button and spinner) */
#controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center; /* Vertically center the button/spinner */
    width: 50px; /* Minimal width */
    height: var(--viewport-size-mobile); /* Match viewport height for centering */
    max-height: var(--viewport-size-desktop); 
    
}

.main-action-btn {
    cursor: pointer;
    border: none;
    font-size: 16px; 
    transition: all 0.2s;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); 
}

/* --- MODIFIED: SHRINK CAMERA BUTTON --- */
#take-selfie-btn {
    width: 50px; 
    height: 50px; 
    padding: 0;
    border-radius: 50%; 
    background-color: var(--primary-color);
    color: var(--text-on-dark);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px; 
    line-height: 1;
    margin: 0; 
}

/* Try On Hairstyle Button Styling */
#try-on-btn {
    width: 90%; 
    max-width: var(--content-max-width);
    padding: 12px 24px;
    border-radius: 8px;
    background-color: var(--highlight-color); 
    color: var(--text-on-dark);
    font-size: 1.1em;
    font-weight: bold;
    box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
    margin-top: 5px; 
    margin-bottom: 10px;
}

/* --- 3. FILTER SECTION (For Collapsible Filters) --- */

.filter-section {
    width: 90%; 
    max-width: var(--content-max-width);
    margin: 0 auto; 
    padding: 0;
    background-color: #fff;
    border-radius: 6px;
    text-align: left; 
}

/* Accordion Button/Header Style */
.filter-section h3 {
    font-size: 0.9em; 
    font-weight: bold;
    margin: 0; 
    padding: 8px 10px;
    text-transform: uppercase;
    display: flex;
    justify-content: space-between; 
    align-items: center;
    cursor: pointer;
    background-color: #fff;
    border-radius: 6px;
    transition: all 0.2s ease-in-out;
}

/* --- MODIFIED: COLLAPSED (SMALLER PILL APPEARANCE) --- */
.filter-section.collapsed h3 {
    background-color: #f0f0f0; 
    color: #666;
    border-radius: 15px; /* Smaller radius */
    height: 30px; /* Smaller height */
    width: auto; /* Auto width to fit content */
    max-width: 150px; /* Max width to keep it small */
    padding: 0 15px; /* Horizontal padding */
    justify-content: center;
    overflow: hidden; 
    margin: 0 auto 10px auto; /* 10px margin-bottom for separation */
    font-size: 0.8em; /* Smaller font size */
}

.filter-section.collapsed h3 span {
    display: inline;
    line-height: 30px; /* Match new height */
}

.filter-section.collapsed h3::after {
    content: none;
}

/* --- EXPANDED (Active Pill/Block Appearance) --- */
.filter-section.expanded h3 {
    background-color: var(--primary-color); 
    color: var(--text-on-dark);
    border-radius: 6px 6px 0 0; 
    height: auto;
    width: 100%;
    max-width: var(--content-max-width); /* Match content width when expanded */
    padding: 8px 10px;
    margin: 0;
    justify-content: space-between; 
}

.filter-section h3::after {
    content: 'â–¶'; 
    font-size: 0.8em;
    margin-left: 5px;
    transition: transform 0.2s;
    line-height: 1;
}

.filter-section.expanded h3::after {
    content: 'â–¼'; 
    color: var(--text-on-dark);
}

.filter-content-group {
    padding: 5px 10px 10px 10px;
    background-color: #f9f9f9;
    border-radius: 0 0 6px 6px;
}

.filter-section.collapsed .filter-content-group {
    display: none;
}


/* Filter options group */
.filter-options-group {
    display: flex;
    flex-wrap: wrap; 
    gap: 8px; 
    justify-content: flex-start; 
    margin-top: 5px; 
}

/* Complexion Tiles (Circular & Compact) */
#complexion-options-group {
    justify-content: flex-start; 
    gap: 6px; 
    padding-top: 5px; 
}

.complexion-tile {
    width: 30px; 
    height: 30px; 
    border: 2px solid transparent; 
    flex-shrink: 0; 
    border-radius: 50%;
}

.complexion-tile p {
    display: none; 
}

.complexion-tile.selected {
    border-color: var(--highlight-color);
    box-shadow: 0 0 5px rgba(40, 167, 69, 0.5); 
}

/* --- Hairstyle Gallery (INSPIRATION) --- */
/* NEW container for the visible style options (not collapsible) */
#style-inspiration-section {
    width: 90%; 
    max-width: var(--content-max-width);
    margin: 0 auto;
    padding: 0 10px;
    text-align: left;
}
#style-inspiration-section p {
    font-size: 0.9em; 
    font-weight: bold;
    margin: 0 0 5px 0;
}

/* Horizontal Scroll Fix for styles */
#hairstyle-options-group {
    display: flex; 
    flex-wrap: nowrap; 
    white-space: nowrap; 
    overflow-x: scroll; 
    overflow-y: hidden; 
    scroll-snap-type: x mandatory;
    gap: 8px;
    padding-bottom: 10px; 
    -webkit-overflow-scrolling: touch; 
}

.style-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    width: 85px; 
    flex-shrink: 0;
    border: 2px solid transparent; 
    transition: all 0.3s ease-out; 
    cursor: pointer;
}

/* ADDED: Hover effect to style options */
.style-option:hover {
    box-shadow: 0 0 5px rgba(0, 0, 0, 0.2); 
    transform: scale(1.05); 
}

.style-option.selected {
    border-color: var(--highlight-color);
    border-radius: 10px; 
    box-shadow: 0 0 10px rgba(40, 167, 69, 0.7); 
    transform: scale(1.1); 
    z-index: 10; 
}

/* --- MODIFIED: LARGER, CIRCULAR THUMBNAILS --- */
.style-thumbnail {
    width: 80px; 
    height: 80px; 
    border-radius: 50%; 
    object-fit: cover;
    margin-bottom: 4px; 
}

.style-option p {
    font-size: 0.75em;
    white-space: normal;
    word-break: break-word;
    margin: 4px 0 0 0;
}

/* ================================================== */
/* ðŸ“± MOBILE MEDIA QUERY OPTIMIZATIONS */
/* ================================================== */

@media (max-width: 600px) {
    
    #main-app-container {
        padding: 10px 0;
        gap: 15px; 
    }
    
    .gender-buttons-container,
    #central-section,
    #style-inspiration-section,
    #additional-filters-selector,
    #try-on-btn {
        width: 95%; 
        max-width: 95%;
        box-sizing: border-box;
        padding: 0 10px;
    }

    /* Keep the small button centered in mobile */
    .filter-section.collapsed h3 {
        width: 95%; 
        max-width: 150px; 
    }

    #style-inspiration-section {
        padding: 0 0 0 10px; 
    }
    
    #central-viewport {
        width: 80vw !important; 
        height: 80vw !important;
        max-width: 300px !important; 
        max-height: 300px !important;
    }
    
    /* Ensure the controls height matches the viewport in mobile view */
    #controls {
        height: 80vw;
    }
    
    #complexion-options-group {
        justify-content: space-around;
        flex-wrap: nowrap;
        overflow-x: scroll;
        padding-bottom: 5px;
        padding-top: 5px;
        scroll-snap-type: x mandatory;
    }

    .complexion-tile {
        width: 40px; 
        height: 40px; 
        flex-shrink: 0;
        position: relative;
    }
    .complexion-tile p {
        display: block; 
        font-size: 0.6em;
        position: absolute;
        top: 100%; 
        left: 50%;
        transform: translateX(-50%);
        margin-top: 5px; 
        width: 60px;
    }
    
    #hairstyle-options-group {
        padding-left: 0;
        padding-right: 10px;
    }
    
    .style-option {
        width: 85px; 
        flex-shrink: 0;
    }
    .style-thumbnail {
        width: 80px; 
        height: 80px; 
    }

    .style-option p {
        font-size: 0.8em;
    }
}
    </style>
</head>
<body>
    <div id="app-header">
        <img id="main-logo" src="assets/Minimalist 'Looks' Logo with Hair Strand Design (1).png" alt="Looks Logo">
    </div>

    <div id="main-app-container">
        
        <div class="gender-buttons-container">
            <button id="male-gender-btn" class="gender-button">Male</button>
            <button id="female-gender-btn" class="gender-button">Female</button>
        </div>

        <div id="additional-filters-selector" class="filter-section collapsed">
            <h3><span>Additional Filters</span><span class="icon"></span></h3>
            <div class="filter-content-group">
                <p style="font-size: 0.9em; font-weight: bold; margin-bottom: 5px;">Complexion (Optional)</p>
                <div id="complexion-options-group" class="filter-options-group">
                    <div class="complexion-tile" style="background-color: #F8D7BE;" data-complexion="Light"></div>
                    <div class="complexion-tile" style="background-color: #D6A476;" data-complexion="Medium"></div>
                    <div class="complexion-tile" style="background-color: #A97A52;" data-complexion="Dark"></div>
                    <div class="complexion-tile" style="background-color: #6A3E26;" data-complexion="Deep"></div>
                </div>
            </div>
        </div>
        
        <div id="style-inspiration-section">
            <p>Hairstyle Inspiration:</p>
            <div id="hairstyle-options-group" class="filter-options-group">
                
                <div class="style-option" data-prompt="A short haircut with a tousled and textured top, dark brown color, sharp side profile.">
                    <img class="style-thumbnail" src="styles/style1.png" alt="Tousled Short Crop">
                    <p>Tousled Short Crop</p>
                </div>
                
                <div class="style-option" data-prompt="A clean fade with a slightly messy wavy top, medium brown color, defined jawline framing">
                    <img class="style-thumbnail" src="styles/style2.png" alt="Wavy Clean Fade">
                    <p>Wavy Clean Fade</p>
                </div>
                
                <div class="style-option" data-prompt="A classic side-part with a smooth combed finish, ash black color, crisp temple blend.">
                    <img class="style-thumbnail" src="styles/style3.png" alt="Classic Side-Part">
                    <p>Classic Side-Part</p>
                </div>
                
                <div class="style-option" data-prompt="A short curly crop with tight texture, deep black color, taper fade around the ears.">
                    <img class="style-thumbnail" src="styles/style4.png" alt="Curly Short Crop">
                    <p>Curly Short Crop</p>
                </div>
                
                <div class="style-option" data-prompt="A medium-length shag with layered volume, chestnut brown color, soft silhouette.">
                    <img class="style-thumbnail" src="styles/style5.png" alt="Layered Shag Cut">
                    <p>Layered Shag Cut</p>
                </div>
                
                <div class="style-option" data-prompt="A buzz cut with subtle texture on top, dark blonde color, strong and structured profile.">
                    <img class="style-thumbnail" src="styles/style6.png" alt="Textured Buzz">
                    <p>Textured Buzz</p>
                </div>
                
                <div class="style-option" data-prompt="A modern quiff with height and soft edges, dark brown color, low fade on the sides.">
                    <img class="style-thumbnail" src="styles/style7.png" alt="Modern Quiff">
                    <p>Modern Quiff</p>
                </div>
                
                <div class="style-option" data-prompt="A textured fringe with choppy layers, sandy brown color, relaxed and youthful feel.">
                    <img class="style-thumbnail" src="styles/style8.png" alt="Textured Fringe">
                    <p>Textured Fringe</p>
                </div>
                
                <div class="style-option" data-prompt="A slick-back style with slight wave, espresso black color, clean undercut detail.">
                    <img class="style-thumbnail" src="styles/style9.png" alt="Wavy Slick-Back">
                    <p>Wavy Slick-Back</p>
                </div>

                <div class="style-option" data-prompt="A cropped Caesar cut with short bangs, warm brown color, sharp and tidy shape.">
                    <img class="style-thumbnail" src="styles/style10.png" alt="Caesar Crop">
                    <p>Caesar Crop</p>
                </div>

                <div class="style-option" data-prompt="A medium-length swept-back style with natural flow, golden brown color, tapered sides.">
                    <img class="style-thumbnail" src="styles/style11.png" alt="Swept-Back Medium">
                    <p>Swept-Back Medium</p>
                </div>

                <div class="style-option" data-prompt="A curly undercut with defined top volume, jet black color, bold contrast in lengths.">
                    <img class="style-thumbnail" src="styles/style12.png" alt="Curly Undercut">
                    <p>Curly Undercut</p>
                </div>
                
                <div class="style-option" data-prompt="A messy medium crop with subtle waves, chocolate brown color, soft shadow fade.">
                    <img class="style-thumbnail" src="styles/style13.png" alt="Messy Medium Crop">
                    <p>Messy Medium Crop</p>
                </div>

                <div class="style-option" data-prompt="A spiky short top with controlled texture, dark brown color, sharp high fade.">
                    <img class="style-thumbnail" src="styles/style14.png" alt="Spiky Short Fade">
                    <p>Spiky Short Fade</p>
                </div>

                <div class="style-option" data-prompt="A long top with brushed-forward texture, deep mahogany color, tight sides for structure.">
                    <img class="style-thumbnail" src="styles/style15.png" alt="Forward Brush Cut">
                    <p>Forward Brush Cut</p>
                </div>
                
                <div class="style-option" data-prompt="A low-maintenance textured buzz with slight stubble blend, dark ash brown color.">
                    <img class="style-thumbnail" src="styles/style16.png" alt="Textured Buzz Fade">
                    <p>Textured Buzz Fade</p>
                </div>

                <div class="style-option" data-prompt="A voluminous pompadour with smooth finish, black-brown color, clean and polished sides.">
                    <img class="style-thumbnail" src="styles/style17.png" alt="Smooth Pompadour">
                    <p>Smooth Pompadour</p>
                </div>
                
                <div class="style-option" data-prompt="A relaxed surfer-style wave with medium length, sandy blonde color, natural movement.">
                    <img class="style-thumbnail" src="styles/style18.png" alt="Surfer Waves">
                    <p>Surfer Waves</p>
                </div>
                
                <div class="style-option" data-prompt="A detailed crop with high contrast fade, smoky black color, strong forehead line.">
                    <img class="style-thumbnail" src="styles/style19.png" alt="High-Contrast Crop">
                    <p>High-Contrast Crop</p>
                </div>
                
                <div class="style-option" data-prompt="A medium layered cut with side sweep, warm auburn brown color, gentle taper.">
                    <img class="style-thumbnail" src="styles/style20.png" alt="Layered Side Sweep">
                    <p>Layered Side Sweep</p>
                </div>
                
                <div class="style-option" data-prompt="A modern mullet with short front and layered back flow, dark charcoal color, bold silhouette.">
                    <img class="style-thumbnail" src="styles/style21.png" alt="Modern Mullet">
                    <p>Modern Mullet</p>
                </div>
                
            </div>
        </div>


        <div id="central-section">
            <div id="camera-and-controls-row"> <div id="central-viewport">
                    <div id="camera-placeholder-icon">
                        </div>
                    
                    <video id="video-feed" autoplay playsinline></video>
                    <img id="ai-result" style="display: none;" src="" alt="AI Hairstyle Result">
                    <p id="status-message">Tap the silhouette above to start your live feed.</p>
                </div>
                
                <div id="controls">
                    <button id="take-selfie-btn" class="main-action-btn">ðŸ“¸</button>
                    <div id="loading-spinner" class="spinner"></div>
                </div>
            </div> </div>

        <button id="try-on-btn" class="main-action-btn" style="display: none;">Generate My New Look</button>

    </div> <canvas id="hidden-canvas" style="display: none;"></canvas>

    <script>
document.addEventListener('DOMContentLoaded', () => {
    // 1. Get DOM elements
    const videoFeed = document.getElementById('video-feed');
    const aiResultImg = document.getElementById('ai-result');
    const canvas = document.getElementById('hidden-canvas');

    const cameraPlaceholderIcon = document.getElementById('camera-placeholder-icon');

    // Buttons and Controls
    const takeSelfieBtn = document.getElementById('take-selfie-btn');
    const tryOnBtn = document.getElementById('try-on-btn');
    const spinner = document.getElementById('loading-spinner');

    const statusMessage = document.getElementById('status-message');

    // Filter elements
    const filtersAccordion = document.getElementById('additional-filters-selector');
    const complexionGroup = document.getElementById('complexion-options-group');
    const styleInspirationContainer = document.getElementById('style-inspiration-section');
    const styleOptionsGroup = document.getElementById('hairstyle-options-group');

    // New Gender Buttons
    const maleGenderBtn = document.getElementById('male-gender-btn');
    const femaleGenderBtn = document.getElementById('female-gender-btn');

    // State tracking variables
    let capturedImageBase64 = null;
    let selectedPrompt = null;
    let cameraStarted = false;
    let selectedGender = 'Male';
    let selectedComplexion = null;
    let imageCaptured = false;

    // --- CONSTANTS ---
    const NEGATIVE_PROMPT = "extra fingers, blurry, low resolution, bad hands, deformed face, mask artifact, bad blending, unnatural hair hair color, ugly, tiling, duplicate, abstract, cartoon, distorted pupils, bad lighting, cropped, grainy, noise, poor lighting, poor composition, low quality, changed clothing, changed background, new outfit, new background, different lighting";

    // --- Helper Functions ---

    function updateTryOnButtonVisibility() {
        if (imageCaptured && selectedPrompt) {
            tryOnBtn.style.display = 'block';
            tryOnBtn.disabled = false;
            if (!statusMessage.textContent.includes('Processing')) {
                 const complexionStatus = selectedComplexion ? `(${selectedComplexion} Complexion selected)` : '(Complexion Auto-Detected)';
                 statusMessage.textContent = `All set! Click 'Generate My New Look' below ${complexionStatus}.`;
            }
        } else {
            tryOnBtn.style.display = 'none';
        }
    }

    function handleGenderSelect(gender) {
        selectedGender = gender;
        maleGenderBtn.classList.remove('selected');
        femaleGenderBtn.classList.remove('selected');
        if (gender === 'Male') {
            maleGenderBtn.classList.add('selected');
        } else if (gender === 'Female') {
            femaleGenderBtn.classList.add('selected');
        }
        
        // FUTURE FEATURE: Add logic here to filter styles based on selectedGender
        
        updateTryOnButtonVisibility();
    }

    function toggleFilterSection(section) {
        if (section.classList.contains('collapsed')) {
            section.classList.remove('collapsed');
            section.classList.add('expanded');
        } else {
            section.classList.remove('expanded');
            section.classList.add('collapsed');
        }
    }

    function handleComplexionSelect(tile) {
        const isSelected = tile.classList.contains('selected');
        const complexionTiles = complexionGroup.querySelectorAll('.complexion-tile');

        complexionTiles.forEach(t => t.classList.remove('selected'));

        if (!isSelected) {
            tile.classList.add('selected');
            selectedComplexion = tile.dataset.complexion;
        } else {
            selectedComplexion = null;
        }

        updateTryOnButtonVisibility();
    }

    function handleStyleSelect(styleOption) {
        // Updated to use the new style options group
        const styleOptions = styleOptionsGroup.querySelectorAll('.style-option');

        styleOptions.forEach(o => {
            o.classList.remove('selected');
            o.style.transform = '';
        });

        styleOption.classList.add('selected');
        selectedPrompt = styleOption.dataset.prompt;

        updateTryOnButtonVisibility();

        if (imageCaptured) {
             statusMessage.textContent = `Style selected. Click 'Generate' or open 'Additional Filters' for complexion.`;
        }
    }


    // --- CRITICAL FIX: startCamera Function with Promise for Stream Loading ---
    async function startCamera() {
        if (cameraStarted) return; 

        statusMessage.textContent = "Requesting camera access...";

        try {
            const constraints = {
                video: {
                    facingMode: 'user', 
                    width: { ideal: 250 },
                    height: { ideal: 250 }
                }
            };
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            
            videoFeed.srcObject = stream;
            
            await new Promise(resolve => {
                videoFeed.onloadedmetadata = () => {
                    videoFeed.play();
                    resolve();
                };
            });

            cameraStarted = true;
            imageCaptured = false;

            cameraPlaceholderIcon.style.display = 'none'; 
            aiResultImg.style.display = 'none';
            videoFeed.style.display = 'block'; 

            takeSelfieBtn.textContent = "ðŸ“¸";
            takeSelfieBtn.disabled = false;
            tryOnBtn.style.display = 'none';

            statusMessage.textContent = "Adjust your face in the box, then click ðŸ“¸ to capture.";

        } catch (error) {
            console.error('Error accessing camera:', error);

            statusMessage.textContent = `Error: Cannot start camera. Check permissions/device settings. (${error.name})`;
            takeSelfieBtn.textContent = "ðŸ“¸";
            takeSelfieBtn.disabled = true; 
            
            cameraPlaceholderIcon.style.display = 'block';
            videoFeed.style.display = 'none';
            
            cameraStarted = false;
        }
    }

    function stopCamera() {
        if (videoFeed.srcObject) {
            videoFeed.srcObject.getTracks().forEach(track => track.stop());
            videoFeed.srcObject = null;
        }
        cameraStarted = false;
    }

    function captureImage() {
        const context = canvas.getContext('2d');
        const width = videoFeed.videoWidth || 250; 
        const height = videoFeed.videoHeight || 250;

        canvas.width = width;
        canvas.height = height;
        
        context.drawImage(videoFeed, 0, 0, width, height);

        const fullDataURL = canvas.toDataURL('image/jpeg');

        // Extract Base64 part only
        const parts = fullDataURL.split(',');
        capturedImageBase64 = parts.length > 1 ? parts[1] : fullDataURL;

        imageCaptured = true;

        videoFeed.style.display = 'none';
        aiResultImg.style.display = 'block';
        aiResultImg.src = fullDataURL; 

        stopCamera();

        statusMessage.textContent = "Image captured. Select a hairstyle to unlock the 'Generate' button.";

        takeSelfieBtn.textContent = "â–¶ï¸"; // Button now means "Start New Session"

        updateTryOnButtonVisibility();
    }

    // Logic for handling the main action button (Capture/Restart)
    takeSelfieBtn.addEventListener('click', () => {
        if (cameraStarted) {
            captureImage();
        } 
        else if (imageCaptured) {
            // Restart Session:
            aiResultImg.style.display = 'none';
            cameraPlaceholderIcon.style.display = 'block';
            imageCaptured = false;
            capturedImageBase64 = null;
            selectedPrompt = null; // Reset selected prompt on restart

            // Clear previous selection visually
            styleOptionsGroup.querySelectorAll('.style-option').forEach(o => {
                o.classList.remove('selected');
                o.style.transform = '';
            });

            // Ensure filters are reset or collapsed if needed on restart
            filtersAccordion.classList.remove('expanded');
            filtersAccordion.classList.add('collapsed');

            takeSelfieBtn.textContent = "ðŸ“¸";
            takeSelfieBtn.disabled = true;
            statusMessage.textContent = "Tap the silhouette above to start your live feed.";
            updateTryOnButtonVisibility();
        }
    });

    // Click listener on the placeholder icon to START the camera
    cameraPlaceholderIcon.addEventListener('click', () => {
        if (!cameraStarted && !imageCaptured) {
            startCamera();
        }
    });
    
    // --- UPDATED TRY ON BUTTON LOGIC WITH DETAILED LOADING STATES ---
    tryOnBtn.addEventListener('click', async () => {
        if (!capturedImageBase64 || !selectedPrompt) {
            statusMessage.textContent = "Please capture a selfie and select a hairstyle first.";
            return;
        }

        // --- START LOADING STATE ---
        tryOnBtn.disabled = true;
        tryOnBtn.style.display = 'none';
        takeSelfieBtn.style.display = 'none'; // Hide the capture button
        spinner.style.display = 'block';
        
        statusMessage.textContent = "1/2. Uploading image and defining style...";

        const complexionClause = selectedComplexion
            ? ` with a ${selectedComplexion} complexion`
            : ``;

        const finalPrompt = `STRICTLY use the provided image as the base. DO NOT change the background, the clothing, or the subject's face/identity. ONLY apply the new hairstyle: ${selectedPrompt}. The final result must be a high quality, professional studio portrait of a ${selectedGender} model${complexionClause} with NO other changes besides the hair.`;

        try {
            // Update status right before the network call
            statusMessage.textContent = "2/2. AI processing your new look (approx 15-30s)...";

            const response = await fetch('/api/run_model', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    baseImage: capturedImageBase64,
                    prompt: finalPrompt,
                    negativePrompt: NEGATIVE_PROMPT 
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
            }

            const data = await response.json();

            // --- SUCCESS BLOCK ---
            aiResultImg.src = `data:image/jpeg;base64,${data.generatedImageBase64}`;
            aiResultImg.style.display = 'block';

            videoFeed.style.display = 'none';
            cameraPlaceholderIcon.style.display = 'none';

            statusMessage.textContent = `Success! Your new look is ready. Click the Play button to start a new session.`;

            takeSelfieBtn.style.display = 'block';
            takeSelfieBtn.textContent = "â–¶ï¸"; // Change to Restart icon
            takeSelfieBtn.disabled = false;

            spinner.style.display = 'none';
            tryOnBtn.style.display = 'none';

        } catch (error) {
            // --- ERROR BLOCK ---
            console.error('AI Processing Error:', error);
            statusMessage.textContent = `Error during AI try-on: ${error.message}. Please check console and retry.`;

            // Reset controls to allow retry
            tryOnBtn.disabled = false;
            tryOnBtn.style.display = 'block';
            takeSelfieBtn.style.display = 'none';
            spinner.style.display = 'none';
        }
    });


    // --- INITIALIZATION and EVENT LISTENERS ---

    // Set initial gender selection
    if (maleGenderBtn) {
        handleGenderSelect('Male');
    }

    if (maleGenderBtn) {
        maleGenderBtn.addEventListener('click', () => handleGenderSelect('Male'));
    }

    if (femaleGenderBtn) {
        femaleGenderBtn.addEventListener('click', () => handleGenderSelect('Female'));
    }

    // New event listener for the Additional Filters accordion
    if (filtersAccordion) {
        filtersAccordion.querySelector('h3').addEventListener('click', () => toggleFilterSection(filtersAccordion));
    }
    
    // Set initial filter state (Additional Filters collapsed)
    if (filtersAccordion) filtersAccordion.classList.add('collapsed');

    if (complexionGroup) {
        complexionGroup.querySelectorAll('.complexion-tile').forEach(tile => {
            tile.addEventListener('click', () => handleComplexionSelect(tile));
        });
    }

    // Updated element to query for style options
    if (styleOptionsGroup) {
        styleOptionsGroup.querySelectorAll('.style-option').forEach(option => {
            option.addEventListener('click', () => handleStyleSelect(option));
        });
    }

    // Initial button state
    takeSelfieBtn.textContent = "ðŸ“¸";
    takeSelfieBtn.disabled = true; 
    spinner.style.display = 'none';
});
    </script>
</body>
</html>
