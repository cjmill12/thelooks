<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hairstyle Virtual Try-On</title>
    
    <style>
/* --- Global Colors --- */
:root {
    --primary-color: #1D2124; 
    --text-on-dark: #FFFFFF; 
    --background-color: #f4f7f6;
    --text-color: #333; 
    --highlight-color: #28a745; 
    --thumbnail-size: 60px;
    --gallery-gap: 10px; 
    --header-height: 45px; /* Increased slightly for text title */
    --viewport-size-desktop: 300px; 
    --viewport-size-mobile: 250px; 
    --content-max-width: 400px; 
}

body {
    font-family: Arial, sans-serif;
    background-color: var(--background-color);
    color: var(--text-color);
    margin: 0;
    padding: 0; 
    text-align: center;
    -webkit-user-select: none;
    user-select: none;
    overflow-x: hidden; 
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

/* --- Header and Logo Styling (MINIMAL BANNER) --- */
#app-header {
    padding: 0; 
    background-color: #FFFFFF;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); 
    height: var(--header-height); 
    display: flex;
    align-items: center;
    justify-content: center;
    position: sticky; 
    top: 0;
    z-index: 100;
}

/* MODIFIED: Title text styling to replace logo */
#main-title {
    color: var(--primary-color);
    font-size: 1.8em; /* Making it prominent */
    font-weight: bold;
    line-height: 1;
    margin: 0;
    padding: 0;
}

/* ================================================== */
/* NEW SINGLE-COLUMN LAYOUT */
/* ================================================== */

#main-app-container {
    flex-grow: 1; 
    width: 100%;
    padding: 20px 0;
    margin: 0 auto; 
    display: flex;
    flex-direction: column;
    align-items: center; 
    gap: 15px; 
}

/* --- 1. GENDER BUTTONS (Top Section) --- */
.gender-buttons-container {
    display: flex;
    justify-content: space-between;
    gap: 8px;
    width: 90%; 
    max-width: var(--content-max-width);
    margin-bottom: 0;
    box-sizing: border-box;
    padding: 0 10px;
}

.gender-button {
    flex-grow: 1;
    padding: 7px 10px; 
    border: 1px solid #ddd; 
    background-color: #ffffff; 
    color: var(--text-color);
    border-radius: 20px; 
    cursor: pointer;
    font-size: 0.8em; 
    font-weight: 500; 
    text-align: center;
    transition: all 0.2s;
    user-select: none;
    line-height: 1;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); 
}

.gender-button:hover {
    background-color: #f0f0f0;
}

.gender-button.selected {
    background-color: var(--primary-color);
    color: var(--text-on-dark);
    border-color: var(--primary-color);
    box-shadow: 0 2px 5px rgba(29, 33, 36, 0.2); 
}


/* --- 2. CAMERA SECTION (Middle Section) --- */

#central-section {
    width: 90%;
    max-width: var(--content-max-width);
    display: flex;
    flex-direction: column; 
    align-items: center;
    justify-content: center;
    gap: 15px;
    padding: 0 10px;
}

/* Old #camera-and-controls-row removed. Viewport is now centered. */
#central-viewport {
    position: relative; 
    width: var(--viewport-size-mobile) !important; 
    height: var(--viewport-size-mobile) !important;
    max-width: var(--viewport-size-desktop) !important; 
    max-height: var(--viewport-size-desktop) !important;
    margin: 0; 
    border-radius: 6px; 
    overflow: hidden;
    background-color: #e0e0e0; 
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
    
    display: flex; 
    align-items: center;
    justify-content: center;
    cursor: pointer; 
    flex-shrink: 0; 
}

/* --- DOTTED HEADSHOT SILHOUETTE STYLES --- */

#camera-placeholder-icon {
    position: relative;
    width: 60%; 
    height: 60%; 
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    /* Dotted Border Style */
    border: 3px dashed #777; 
    border-radius: 6px;
    background-color: #e8e8e8;
}

/* Head (Circle) */
#camera-placeholder-icon::before {
    content: '';
    position: absolute;
    top: 15%; 
    width: 40%;
    height: 40%;
    background-color: #aaa;
    border-radius: 50%;
}

/* Shoulders (Arc) */
#camera-placeholder-icon::after {
    content: '';
    position: absolute;
    bottom: -15%; 
    width: 80%;
    height: 60%;
    background-color: #aaa;
    border-radius: 50% 50% 0 0; 
}


/* Ensure video and result images fill the viewport */
#video-feed, #ai-result {
    width: 100% !important;
    height: 100% !important; 
    display: block;
    object-fit: cover !important; 
    max-width: 100% !important;
    max-height: 100% !important;
    z-index: 1; 
    display: none; 
}

#status-message {
    position: absolute;
    bottom: 0;
    width: 100%;
    background: rgba(0, 0, 0, 0.6);
    color: white;
    padding: 8px 5px;
    margin: 0;
    font-size: 0.85em;
    text-align: center;
    z-index: 100; 
}

/* --- NEW: Circular Button Styling --- */
.main-action-btn {
    cursor: pointer;
    border: none;
    transition: all 0.2s;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); 
}

.circular-action-btn {
    width: 60px; 
    height: 60px; 
    padding: 0;
    border-radius: 50%; 
    background-color: var(--primary-color);
    color: var(--text-on-dark);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px; 
    line-height: 1;
    margin: 0; 
    flex-shrink: 0;
}

/* --- NEW: Controls Footer Row --- */
#controls-footer-row {
    display: flex;
    justify-content: center; 
    gap: 30px; 
    width: 90%; 
    max-width: var(--content-max-width);
    padding: 0 10px;
    min-height: 60px; 
    align-items: center;
    position: relative; 
}

/* Spinner adjustment to center over the button area */
#loading-spinner {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
}

/* --- 3. FILTER SECTION (For Collapsible Filters) --- */

.filter-section {
    width: 90%; 
    max-width: var(--content-max-width);
    margin: 0 auto; 
    padding: 0;
    background-color: #fff;
    border-radius: 6px;
    text-align: left; 
}

/* Accordion Button/Header Style */
.filter-section h3 {
    font-size: 0.9em; 
    font-weight: bold;
    margin: 0; 
    padding: 8px 10px;
    text-transform: uppercase;
    display: flex;
    justify-content: space-between; 
    align-items: center;
    cursor: pointer;
    background-color: #fff;
    border-radius: 6px;
    transition: all 0.2s ease-in-out;
}

/* --- MODIFIED: COLLAPSED (SMALLER PILL APPEARANCE) --- */
.filter-section.collapsed h3 {
    background-color: #f0f0f0; 
    color: #666;
    border-radius: 15px; 
    height: 28px; 
    width: auto; 
    max-width: 160px; 
    padding: 0 15px; 
    justify-content: center;
    overflow: hidden; 
    margin: 0 auto 10px auto; 
    font-size: 0.75em; 
}

.filter-section.collapsed h3 span {
    display: inline;
    line-height: 28px; 
}

.filter-section.collapsed h3::after {
    content: none;
}

/* --- EXPANDED (Active Pill/Block Appearance) --- */
.filter-section.expanded h3 {
    background-color: var(--primary-color); 
    color: var(--text-on-dark);
    border-radius: 6px 6px 0 0; 
    height: auto;
    width: 100%;
    max-width: var(--content-max-width); 
    padding: 8px 10px;
    margin: 0;
    justify-content: space-between; 
}

.filter-section h3::after {
    content: 'â–¶'; 
    font-size: 0.8em;
    margin-left: 5px;
    transition: transform 0.2s;
    line-height: 1;
}

.filter-section.expanded h3::after {
    content: 'â–¼'; 
    color: var(--text-on-dark);
}

.filter-content-group {
    padding: 5px 10px 10px 10px;
    background-color: #f9f9f9;
    border-radius: 0 0 6px 6px;
}

.filter-section.collapsed .filter-content-group {
    display: none;
}


/* Filter options group */
.filter-options-group {
    display: flex;
    flex-wrap: wrap; 
    gap: 8px; 
    justify-content: flex-start; 
    margin-top: 5px; 
}

/* Complexion Tiles (Circular & Compact) */
#complexion-options-group {
    justify-content: flex-start; 
    gap: 6px; 
    padding-top: 5px; 
}

.complexion-tile {
    width: 30px; 
    height: 30px; 
    border: 2px solid transparent; 
    flex-shrink: 0; 
    border-radius: 50%;
}

.complexion-tile p {
    display: none; 
}

.complexion-tile.selected {
    border-color: var(--highlight-color);
    box-shadow: 0 0 5px rgba(40, 167, 69, 0.5); 
}

/* --- Hairstyle Gallery (INSPIRATION) --- */
#style-inspiration-section {
    width: 90%; 
    max-width: var(--content-max-width);
    margin: 0 auto;
    padding: 0 10px;
    text-align: center; 
}
#style-inspiration-section p {
    font-size: 0.9em; 
    font-weight: bold;
    margin: 0 0 5px 0;
}

/* Horizontal Scroll Fix for styles */
#hairstyle-options-group {
    display: flex; 
    flex-wrap: nowrap; 
    white-space: nowrap; 
    overflow-x: scroll; 
    overflow-y: hidden; 
    scroll-snap-type: x mandatory;
    gap: 8px;
    padding-bottom: 10px; 
    -webkit-overflow-scrolling: touch; 
}

.style-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    width: 85px; 
    flex-shrink: 0;
    border: 2px solid transparent; 
    transition: all 0.3s ease-out; 
    cursor: pointer;
}

/* ADDED: Hover effect to style options */
.style-option:hover {
    box-shadow: 0 0 5px rgba(0, 0, 0, 0.2); 
    transform: scale(1.05); 
}

.style-option.selected {
    border-color: var(--highlight-color);
    border-radius: 10px; 
    box-shadow: 0 0 10px rgba(40, 167, 69, 0.7); 
    transform: scale(1.1); 
    z-index: 10; 
}

/* --- MODIFIED: LARGER, CIRCULAR THUMBNAILS --- */
.style-thumbnail {
    width: 80px; 
    height: 80px; 
    border-radius: 50%; 
    object-fit: cover;
    margin-bottom: 4px; 
}

.style-option p {
    font-size: 0.75em;
    white-space: normal;
    word-break: break-word;
    margin: 4px 0 0 0;
}

/* ================================================== */
/* ðŸ“± MOBILE MEDIA QUERY OPTIMIZATIONS */
/* ================================================== */

@media (max-width: 600px) {
    
    #main-app-container {
        padding: 10px 0;
        gap: 15px; 
    }
    
    .gender-buttons-container,
    #central-section,
    #style-inspiration-section,
    #additional-filters-selector,
    #controls-footer-row {
        width: 95%; 
        max-width: 95%;
        box-sizing: border-box;
        padding: 0 10px;
    }

    /* Keep the small button centered in mobile */
    .filter-section.collapsed h3 {
        width: 95%; 
        max-width: 160px; 
    }

    #style-inspiration-section {
        padding: 0 0 0 10px; 
    }
    
    #central-viewport {
        width: 80vw !important; 
        height: 80vw !important;
        max-width: 300px !important; 
        max-height: 300px !important;
    }
    
    #complexion-options-group {
        justify-content: space-around;
        flex-wrap: nowrap;
        overflow-x: scroll;
        padding-bottom: 5px;
        padding-top: 5px;
        scroll-snap-type: x mandatory;
    }

    .complexion-tile {
        width: 40px; 
        height: 40px; 
        flex-shrink: 0;
        position: relative;
    }
    .complexion-tile p {
        display: block; 
        font-size: 0.6em;
        position: absolute;
        top: 100%; 
        left: 50%;
        transform: translateX(-50%);
        margin-top: 5px; 
        width: 60px;
    }
    
    #hairstyle-options-group {
        padding-left: 0;
        padding-right: 10px;
    }
    
    .style-option {
        width: 85px; 
        flex-shrink: 0;
    }
    .style-thumbnail {
        width: 80px; 
        height: 80px; 
    }

    .style-option p {
        font-size: 0.8em;
    }
}
    </style>
</head>
<body>
    <div id="app-header">
        <h1 id="main-title">Looks</h1>
    </div>

    <div id="main-app-container">
        
        <div class="gender-buttons-container">
            <button id="male-gender-btn" class="gender-button">Male</button>
            <button id="female-gender-btn" class="gender-button">Female</button>
        </div>

        <div id="additional-filters-selector" class="filter-section collapsed">
            <h3><span>+ Additional Filters</span><span class="icon"></span></h3>
            <div class="filter-content-group">
                <p style="font-size: 0.9em; font-weight: bold; margin-bottom: 5px;">Complexion (Optional)</p>
                <div id="complexion-options-group" class="filter-options-group">
                    <div class="complexion-tile" style="background-color: #F8D7BE;" data-complexion="Light"></div>
                    <div class="complexion-tile" style="background-color: #D6A476;" data-complexion="Medium"></div>
                    <div class="complexion-tile" style="background-color: #A97A52;" data-complexion="Dark"></div>
                    <div class="complexion-tile" style="background-color: #6A3E26;" data-complexion="Deep"></div>
                </div>
            </div>
        </div>
        
        <div id="central-section">
            <div id="central-viewport">
                <div id="camera-placeholder-icon">
                    </div>
                
                <video id="video-feed" autoplay playsinline></video>
                <img id="ai-result" style="display: none;" src="" alt="AI Hairstyle Result">
                <p id="status-message">Tap the silhouette above to take a selfie.</p>
            </div>
        </div>
        
        <div id="controls-footer-row">
            <button id="camera-capture-btn" class="circular-action-btn main-action-btn" disabled>ðŸ“¸</button> 
            
            <button id="redo-selfie-btn" class="circular-action-btn main-action-btn" style="display: none;">ðŸ”„</button>
            
            <button id="generate-look-btn" class="circular-action-btn main-action-btn" style="display: none;">âœ¨</button>
            
            <div id="loading-spinner" class="spinner" style="display: none;"></div>
        </div>

        <div id="style-inspiration-section">
            <p>Get the Look</p>
            <div id="hairstyle-options-group" class="filter-options-group">
                
                <div class="style-option" data-prompt="A short haircut with a tousled and textured top, dark brown color, sharp side profile.">
                    <img class="style-thumbnail" src="styles/style1.png" alt="Tousled Short Crop">
                    <p>Tousled Short Crop</p>
                </div>
                <div class="style-option" data-prompt="A clean fade with a slightly messy wavy top, medium brown color, defined jawline framing">
                    <img class="style-thumbnail" src="styles/style2.png" alt="Wavy Clean Fade">
                    <p>Wavy Clean Fade</p>
                </div>
                <div class="style-option" data-prompt="A classic side-part with a smooth combed finish, ash black color, crisp temple blend.">
                    <img class="style-thumbnail" src="styles/style3.png" alt="Classic Side-Part">
                    <p>Classic Side-Part</p>
                </div>
                <div class="style-option" data-prompt="A short curly crop with tight texture, deep black color, taper fade around the ears.">
                    <img class="style-thumbnail" src="styles/style4.png" alt="Curly Short Crop">
                    <p>Curly Short Crop</p>
                </div>
                <div class="style-option" data-prompt="A medium-length shag with layered volume, chestnut brown color, soft silhouette.">
                    <img class="style-thumbnail" src="styles/style5.png" alt="Layered Shag Cut">
                    <p>Layered Shag Cut</p>
                </div>
                <div class="style-option" data-prompt="A buzz cut with subtle texture on top, dark blonde color, strong and structured profile.">
                    <img class="style-thumbnail" src="styles/style6.png" alt="Textured Buzz">
                    <p>Textured Buzz</p>
                </div>
                <div class="style-option" data-prompt="A modern quiff with height and soft edges, dark brown color, low fade on the sides.">
                    <img class="style-thumbnail" src="styles/style7.png" alt="Modern Quiff">
                    <p>Modern Quiff</p>
                </div>
                <div class="style-option" data-prompt="A textured fringe with choppy layers, sandy brown color, relaxed and youthful feel.">
                    <img class="style-thumbnail" src="styles/style8.png" alt="Textured Fringe">
                    <p>Textured Fringe</p>
                </div>
                <div class="style-option" data-prompt="A slick-back style with slight wave, espresso black color, clean undercut detail.">
                    <img class="style-thumbnail" src="styles/style9.png" alt="Wavy Slick-Back">
                    <p>Wavy Slick-Back</p>
                </div>
                <div class="style-option" data-prompt="A cropped Caesar cut with short bangs, warm brown color, sharp and tidy shape.">
                    <img class="style-thumbnail" src="styles/style10.png" alt="Caesar Crop">
                    <p>Caesar Crop</p>
                </div>
                <div class="style-option" data-prompt="A medium-length swept-back style with natural flow, golden brown color, tapered sides.">
                    <img class="style-thumbnail" src="styles/style11.png" alt="Swept-Back Medium">
                    <p>Swept-Back Medium</p>
                </div>
                <div class="style-option" data-prompt="A curly undercut with defined top volume, jet black color, bold contrast in lengths.">
                    <img class="style-thumbnail" src="styles/style12.png" alt="Curly Undercut">
                    <p>Curly Undercut</p>
                </div>
                <div class="style-option" data-prompt="A messy medium crop with subtle waves, chocolate brown color, soft shadow fade.">
                    <img class="style-thumbnail" src="styles/style13.png" alt="Messy Medium Crop">
                    <p>Messy Medium Crop</p>
                </div>
                <div class="style-option" data-prompt="A spiky short top with controlled texture, dark brown color, sharp high fade.">
                    <img class="style-thumbnail" src="styles/style14.png" alt="Spiky Short Fade">
                    <p>Spiky Short Fade</p>
                </div>
                <div class="style-option" data-prompt="A long top with brushed-forward texture, deep mahogany color, tight sides for structure.">
                    <img class="style-thumbnail" src="styles/style15.png" alt="Forward Brush Cut">
                    <p>Forward Brush Cut</p>
                </div>
                <div class="style-option" data-prompt="A low-maintenance textured buzz with slight stubble blend, dark ash brown color.">
                    <img class="style-thumbnail" src="styles/style16.png" alt="Textured Buzz Fade">
                    <p>Textured Buzz Fade</p>
                </div>
                <div class="style-option" data-prompt="A voluminous pompadour with smooth finish, black-brown color, clean and polished sides.">
                    <img class="style-thumbnail" src="styles/style17.png" alt="Smooth Pompadour">
                    <p>Smooth Pompadour</p>
                </div>
                <div class="style-option" data-prompt="A relaxed surfer-style wave with medium length, sandy blonde color, natural movement.">
                    <img class="style-thumbnail" src="styles/style18.png" alt="Surfer Waves">
                    <p>Surfer Waves</p>
                </div>
                <div class="style-option" data-prompt="A detailed crop with high contrast fade, smoky black color, strong forehead line.">
                    <img class="style-thumbnail" src="styles/style19.png" alt="High-Contrast Crop">
                    <p>High-Contrast Crop</p>
                </div>
                <div class="style-option" data-prompt="A medium layered cut with side sweep, warm auburn brown color, gentle taper.">
                    <img class="style-thumbnail" src="styles/style20.png" alt="Layered Side Sweep">
                    <p>Layered Side Sweep</p>
                </div>
                <div class="style-option" data-prompt="A modern mullet with short front and layered back flow, dark charcoal color, bold silhouette.">
                    <img class="style-thumbnail" src="styles/style21.png" alt="Modern Mullet">
                    <p>Modern Mullet</p>
                </div>
                
            </div>
        </div>

    </div> <canvas id="hidden-canvas" style="display: none;"></canvas>

    <script>
document.addEventListener('DOMContentLoaded', () => {
    // 1. Get DOM elements
    const videoFeed = document.getElementById('video-feed');
    const aiResultImg = document.getElementById('ai-result');
    const canvas = document.getElementById('hidden-canvas');
    const cameraPlaceholderIcon = document.getElementById('camera-placeholder-icon');

    // NEW BUTTONS AND CONTROLS
    const cameraCaptureBtn = document.getElementById('camera-capture-btn');
    const redoSelfieBtn = document.getElementById('redo-selfie-btn');
    const generateLookBtn = document.getElementById('generate-look-btn');
    const spinner = document.getElementById('loading-spinner');
    const statusMessage = document.getElementById('status-message');

    // Filter elements
    const filtersAccordion = document.getElementById('additional-filters-selector');
    const complexionGroup = document.getElementById('complexion-options-group');
    const styleOptionsGroup = document.getElementById('hairstyle-options-group');
    const maleGenderBtn = document.getElementById('male-gender-btn');
    const femaleGenderBtn = document.getElementById('female-gender-btn');

    // State tracking variables
    let capturedImageBase64 = null;
    let selectedPrompt = null;
    let cameraStarted = false;
    let selectedGender = 'Male';
    let selectedComplexion = null;
    let imageCaptured = false;

    // --- CONSTANTS ---
    const NEGATIVE_PROMPT = "extra fingers, blurry, low resolution, bad hands, deformed face, mask artifact, bad blending, unnatural hair hair color, ugly, tiling, duplicate, abstract, cartoon, distorted pupils, bad lighting, cropped, grainy, noise, poor lighting, poor composition, low quality, changed clothing, changed background, new outfit, new background, different lighting";

    // --- Helper Functions ---

    function updateButtonVisibility() {
        // Reset all buttons
        cameraCaptureBtn.style.display = 'none';
        redoSelfieBtn.style.display = 'none';
        generateLookBtn.style.display = 'none';
        spinner.style.display = 'none';

        if (spinner.classList.contains('active')) {
            // Processing State: Hide all buttons and show spinner
            spinner.style.display = 'block';
        } else if (imageCaptured) {
            // Image Captured State
            redoSelfieBtn.style.display = 'flex'; // Show Redo button
            if (selectedPrompt) {
                generateLookBtn.style.display = 'flex'; // Show Generate button if style is selected
                generateLookBtn.disabled = false;
                const complexionStatus = selectedComplexion ? `(${selectedComplexion} Complexion selected)` : '';
                statusMessage.textContent = `Style selected. Click âœ¨ to generate ${complexionStatus}.`;
            } else {
                statusMessage.textContent = "Image captured. Select a hairstyle to unlock the 'Generate' button.";
            }
        } else {
            // Camera/Initial State
            cameraCaptureBtn.style.display = 'flex';
            cameraCaptureBtn.disabled = !cameraStarted; // Enable only if camera is streaming
            if (cameraStarted) {
                statusMessage.textContent = "Adjust your face in the box, then click ðŸ“¸ to capture.";
            } else {
                // MODIFIED: Updated status message
                statusMessage.textContent = "Tap the silhouette above to take a selfie"; 
            }
        }
    }

    function handleGenderSelect(gender) {
        selectedGender = gender;
        maleGenderBtn.classList.remove('selected');
        femaleGenderBtn.classList.remove('selected');
        if (gender === 'Male') {
            maleGenderBtn.classList.add('selected');
        } else if (gender === 'Female') {
            femaleGenderBtn.classList.add('selected');
        }
        updateButtonVisibility();
    }

    function toggleFilterSection(section) {
        if (section.classList.contains('collapsed')) {
            section.classList.remove('collapsed');
            section.classList.add('expanded');
        } else {
            section.classList.remove('expanded');
            section.classList.add('collapsed');
        }
    }

    function handleComplexionSelect(tile) {
        const isSelected = tile.classList.contains('selected');
        const complexionTiles = complexionGroup.querySelectorAll('.complexion-tile');

        complexionTiles.forEach(t => t.classList.remove('selected'));

        if (!isSelected) {
            tile.classList.add('selected');
            selectedComplexion = tile.dataset.complexion;
        } else {
            selectedComplexion = null;
        }
        updateButtonVisibility();
    }

    function handleStyleSelect(styleOption) {
        const styleOptions = styleOptionsGroup.querySelectorAll('.style-option');

        styleOptions.forEach(o => {
            o.classList.remove('selected');
            o.style.transform = '';
        });

        styleOption.classList.add('selected');
        selectedPrompt = styleOption.dataset.prompt;

        updateButtonVisibility();
    }

    // --- Camera Functions ---

    async function startCamera() {
        if (cameraStarted) return; 

        statusMessage.textContent = "Requesting camera access...";
        cameraCaptureBtn.disabled = true;

        try {
            const constraints = {
                video: {
                    facingMode: 'user', 
                    width: { ideal: 250 },
                    height: { ideal: 250 }
                }
            };
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            
            videoFeed.srcObject = stream;
            
            await new Promise(resolve => {
                videoFeed.onloadedmetadata = () => {
                    videoFeed.play();
                    resolve();
                };
            });

            cameraStarted = true;
            imageCaptured = false;

            cameraPlaceholderIcon.style.display = 'none'; 
            aiResultImg.style.display = 'none';
            videoFeed.style.display = 'block'; 

            updateButtonVisibility();

        } catch (error) {
            console.error('Error accessing camera:', error);
            statusMessage.textContent = `Error: Cannot start camera. Check permissions/device settings. (${error.name})`;
            
            cameraPlaceholderIcon.style.display = 'block';
            videoFeed.style.display = 'none';
            cameraStarted = false;
            updateButtonVisibility(); 
        }
    }

    function stopCamera() {
        if (videoFeed.srcObject) {
            videoFeed.srcObject.getTracks().forEach(track => track.stop());
            videoFeed.srcObject = null;
        }
        cameraStarted = false;
    }

    function captureImage() {
        if (!cameraStarted) return;

        const context = canvas.getContext('2d');
        const width = videoFeed.videoWidth || 250; 
        const height = videoFeed.videoHeight || 250;

        canvas.width = width;
        canvas.height = height;
        
        context.drawImage(videoFeed, 0, 0, width, height);

        const fullDataURL = canvas.toDataURL('image/jpeg');

        const parts = fullDataURL.split(',');
        capturedImageBase64 = parts.length > 1 ? parts[1] : fullDataURL;

        imageCaptured = true;

        videoFeed.style.display = 'none';
        aiResultImg.style.display = 'block';
        aiResultImg.src = fullDataURL; 

        stopCamera();

        updateButtonVisibility();
    }

    function resetSession() {
        stopCamera();
        aiResultImg.style.display = 'none';
        cameraPlaceholderIcon.style.display = 'block';
        imageCaptured = false;
        capturedImageBase64 = null;
        selectedPrompt = null; 
        spinner.classList.remove('active');

        // Clear previous selection visually
        styleOptionsGroup.querySelectorAll('.style-option').forEach(o => {
            o.classList.remove('selected');
            o.style.transform = '';
        });

        // Ensure filters are reset or collapsed if needed on restart
        filtersAccordion.classList.remove('expanded');
        filtersAccordion.classList.add('collapsed');

        updateButtonVisibility();
    }

    // --- Button Event Listeners ---

    // 1. Capture/Start Camera (Click on the button)
    cameraCaptureBtn.addEventListener('click', () => {
        captureImage();
    });

    // Capture/Start Camera (Click on the placeholder)
    cameraPlaceholderIcon.addEventListener('click', () => {
        if (!cameraStarted && !imageCaptured) {
            startCamera();
        }
    });

    // 2. Redo Selfie Button (ðŸ”„)
    redoSelfieBtn.addEventListener('click', () => {
        resetSession();
        startCamera(); // Immediately start camera after reset
    });

    // 3. Generate Button (âœ¨)
    generateLookBtn.addEventListener('click', async () => {
        if (!capturedImageBase64 || !selectedPrompt) {
            statusMessage.textContent = "Please capture a selfie and select a hairstyle first.";
            return;
        }

        // --- START LOADING STATE ---
        spinner.classList.add('active');
        updateButtonVisibility();
        
        // MODIFIED: Simplified status message
        statusMessage.textContent = "Uploading image and defining style...";

        const complexionClause = selectedComplexion
            ? ` with a ${selectedComplexion} complexion`
            : ``;

        // AGGRESSIVELY OPTIMIZED PROMPT FOR STRICT INPAINTING/EDITING
        const finalPrompt = `STRICTLY operate in an inpainting/editing mode. The ONLY element to be changed is the subject's hair. PRESERVE the subject's face, identity, expression, clothing, and background EXACTLY as they appear in the original photograph. Apply the following hairstyle, matching its texture, color, and shape: ${selectedPrompt}. The final result must be a high quality, professional studio portrait of a ${selectedGender} model${complexionClause} with NO other changes besides the hair.`;

        try {
            // MODIFIED: Simplified status message
            statusMessage.textContent = "Processing your new look"; 

            const response = await fetch('/api/run_model', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    baseImage: capturedImageBase64,
                    prompt: finalPrompt,
                    negativePrompt: NEGATIVE_PROMPT 
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
            }

            const data = await response.json();

            // --- SUCCESS BLOCK ---
            aiResultImg.src = `data:image/jpeg;base64,${data.generatedImageBase64}`;
            aiResultImg.style.display = 'block';
            videoFeed.style.display = 'none';
            cameraPlaceholderIcon.style.display = 'none';

            statusMessage.textContent = `Success! Your new look is ready. Click the Redo button to take a new selfie.`;

            // Exit loading state
            spinner.classList.remove('active');
            updateButtonVisibility();

            // Hide the Generate button after successful generation, show Redo
            generateLookBtn.style.display = 'none'; 
            redoSelfieBtn.style.display = 'flex'; 

        } catch (error) {
            // --- ERROR BLOCK ---
            console.error('AI Processing Error:', error);
            statusMessage.textContent = `Error during AI try-on: ${error.message}. Please check console and retry.`;

            // Reset controls to allow retry
            spinner.classList.remove('active');
            updateButtonVisibility();
        }
    });


    // --- INITIALIZATION and EVENT LISTENERS ---

    if (maleGenderBtn) {
        handleGenderSelect('Male');
        maleGenderBtn.addEventListener('click', () => handleGenderSelect('Male'));
    }

    if (femaleGenderBtn) {
        femaleGenderBtn.addEventListener('click', () => handleGenderSelect('Female'));
    }

    if (filtersAccordion) {
        filtersAccordion.querySelector('h3').addEventListener('click', () => toggleFilterSection(filtersAccordion));
        filtersAccordion.classList.add('collapsed');
    }

    if (complexionGroup) {
        complexionGroup.querySelectorAll('.complexion-tile').forEach(tile => {
            tile.addEventListener('click', () => handleComplexionSelect(tile));
        });
    }

    if (styleOptionsGroup) {
        styleOptionsGroup.querySelectorAll('.style-option').forEach(option => {
            option.addEventListener('click', () => handleStyleSelect(option));
        });
    }

    // Initial state setup
    updateButtonVisibility();
});
    </script>
</body>
</html>
