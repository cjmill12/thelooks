<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hairstyle Virtual Try-On</title>
    
    <style>
/* ================================================== */
/* NEW REDESIGN: HIGH-CONTRAST DARK MODE STYLES */
/* ================================================== */

:root {
    --primary-color: #1a1a1a; /* Deep Charcoal Background */
    --secondary-color: #2c2c2c; /* Slightly Lighter Section Background */
    --text-on-dark: #f0f0f0; /* Light Text */
    --highlight-color: #E03E3E; /* NEON RED - New Highlight */
    --text-color: #cccccc; /* Subtle Grey Text */
    --secondary-highlight: #007bff; /* Blue for booking (kept) */
    --header-height: 55px; 
    --viewport-size-mobile: 280px; 
    --content-max-width: 420px; 
}

body {
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background-color: var(--primary-color);
    color: var(--text-color);
    margin: 0;
    padding: 0; 
    text-align: center;
    -webkit-user-select: none;
    user-select: none;
    overflow-x: hidden; 
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

/* --- Header and Logo Styling --- */
#app-header {
    padding: 0; 
    background-color: var(--secondary-color);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); 
    height: var(--header-height); 
    display: flex;
    align-items: center;
    justify-content: center;
    position: sticky; 
    top: 0;
    z-index: 100;
}

#main-title-container {
    display: flex;
    align-items: center;
    gap: 8px; 
}

#header-logo {
    filter: invert(1); /* Invert logo color for dark background if needed */
    height: 35px; 
    width: 35px; 
}

#main-title {
    color: var(--text-on-dark);
    font-size: 1.8em; 
    font-weight: 700;
    letter-spacing: 1px;
    margin: 0;
}

/* ================================================== */
/* MAIN LAYOUT */
/* ================================================== */

#main-app-container {
    flex-grow: 1; 
    width: 100%;
    padding: 15px 0;
    margin: 0 auto; 
    display: flex;
    flex-direction: column;
    align-items: center; 
    gap: 20px; /* Increased spacing */
}

/* --- 1. GENDER BUTTONS --- */
.gender-buttons-container {
    display: flex;
    justify-content: space-between;
    gap: 12px;
    width: 90%; 
    max-width: var(--content-max-width);
    padding: 0 10px;
}

.gender-button {
    flex-grow: 1;
    padding: 10px 15px; 
    border: 1px solid #444; 
    background-color: var(--secondary-color); 
    color: var(--text-on-dark);
    border-radius: 4px; /* Slightly squarer, modern look */
    font-size: 0.9em; 
    transition: all 0.2s;
    box-shadow: 0 1px 5px rgba(0, 0, 0, 0.2); 
}

.gender-button:hover {
    background-color: #383838;
}

.gender-button.selected {
    background-color: var(--highlight-color);
    color: white;
    border-color: var(--highlight-color);
    box-shadow: 0 0 15px rgba(224, 62, 62, 0.5); /* Glowing effect */
}


/* --- 2. CAMERA SECTION --- */

#central-section {
    width: 90%;
    max-width: var(--content-max-width);
    gap: 15px;
    padding: 0 10px;
}

#central-viewport {
    width: var(--viewport-size-mobile) !important; 
    height: var(--viewport-size-mobile) !important;
    margin: 0; 
    border-radius: 8px; 
    background-color: #383838; 
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5); 
    border: 3px solid var(--highlight-color); /* Highlighted border */
}

/* --- DOTTED HEADSHOT SILHOUETTE STYLES --- */
#camera-placeholder-icon {
    border: 3px dashed var(--highlight-color); 
    background-color: #2c2c2c;
}
#camera-placeholder-icon::before, #camera-placeholder-icon::after {
    background-color: #555;
}

#status-message {
    background: rgba(0, 0, 0, 0.8);
    color: var(--text-on-dark);
    padding: 10px 5px;
    font-size: 0.85em;
    font-weight: 500;
}

/* --- Circular Button Styling (ALL ACTION BUTTONS) --- */
.circular-action-btn {
    width: 55px; /* Slightly larger */
    height: 55px; 
    background-color: var(--secondary-color);
    color: var(--text-on-dark);
    font-size: 28px; 
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); 
    border: 2px solid var(--text-on-dark); /* White outline for contrast */
}

/* --- Camera Button (ðŸ“¸) --- */
#camera-capture-btn {
    border: 4px solid var(--text-on-dark); 
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
}

/* --- Generate Button (âœ¨) --- */
#generate-look-btn {
    background-color: var(--highlight-color); 
    color: white; 
    box-shadow: 0 0 20px rgba(224, 62, 62, 0.7); /* Deep glow */
    border-color: white;
}

/* --- Redo Button (ðŸ”„) --- */
#redo-selfie-btn {
    background-color: #444;
    color: var(--text-on-dark); 
    border: 1px solid #555;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
}

/* --- Booking Button (Full width) --- */
#book-appointment-btn {
    height: 50px; 
    border-radius: 4px; /* Match gender button style */
    background-color: var(--secondary-highlight); 
    color: white; 
    font-size: 1.1em;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(0, 123, 255, 0.5); 
}

/* --- Controls Footer Row --- */
#controls-footer-row {
    gap: 30px; 
    min-height: 60px; 
}


/* --- 3. FILTER SECTION --- */

.filter-section {
    background-color: var(--secondary-color);
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}

.filter-section h3 {
    font-size: 0.9em; 
    color: var(--text-on-dark);
    background-color: var(--secondary-color);
    border-radius: 8px; 
}

.filter-section.expanded h3 {
    background-color: #444; 
    border-radius: 8px 8px 0 0; 
}

.filter-section.collapsed h3 {
    background-color: #444; 
    color: var(--text-on-dark);
    border-radius: 20px; 
}

.filter-content-group {
    background-color: #383838;
    border-radius: 0 0 8px 8px;
    border-top: 1px solid #555;
}

.filter-options-group {
    gap: 10px; 
}

/* Complexion Tiles */
.complexion-tile {
    border: 3px solid transparent; 
}

.complexion-tile.selected {
    border-color: var(--highlight-color);
    box-shadow: 0 0 5px rgba(224, 62, 62, 0.8); 
}

/* --- Hairstyle Gallery (INSPIRATION) --- */
#style-inspiration-section p {
    font-size: 1em; 
    font-weight: 700;
    color: var(--text-on-dark);
    margin: 0 0 10px 0;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.hairstyle-options-group-wrapper {
    gap: 15px;
    padding-bottom: 15px; 
}

.style-option {
    width: 130px; /* Slightly bigger thumbnails */
    border: 3px solid transparent; 
    border-radius: 10px;
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); /* More exciting transition */
}

.style-option.selected {
    border-color: var(--highlight-color);
    border-radius: 10px; 
    box-shadow: 0 0 18px rgba(224, 62, 62, 0.9) !important; 
    transform: scale(1.15) !important; /* Slightly less aggressive scale up */
}

.style-thumbnail {
    width: 130px; 
    height: 130px; 
    border-radius: 50%; 
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
}

/* --- Modal Styles --- */
.booking-modal {
    background: var(--secondary-color);
    border-radius: 10px;
    box-shadow: 0 5px 25px rgba(0, 0, 0, 0.8);
    color: var(--text-on-dark);
}

.booking-modal h2 {
    color: var(--highlight-color);
    border-bottom: 1px solid #444;
}

.modal-content input, .modal-content select, .modal-content button.submit-btn {
    border: 1px solid #555;
    background-color: #383838;
    color: var(--text-on-dark);
}

.modal-content button.submit-btn {
    background-color: var(--secondary-highlight);
    box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4); 
}

    </style>
</head>
<body>
    <div id="app-header">
        <div id="main-title-container">
            <img id="header-logo" src="assets/staghouse.png" alt="Stag House Logo">
            <h1 id="main-title">Stag House</h1>
        </div>
    </div>

    <div id="main-app-container">
        
        <div class="gender-buttons-container">
            <button id="male-gender-btn" class="gender-button">Male</button>
            <button id="female-gender-btn" class="gender-button">Female</button>
        </div>

        <div id="additional-filters-selector" class="filter-section collapsed">
            <h3><span>+ Additional Filters</span><span class="icon"></span></h3>
            <div class="filter-content-group">
                <p style="font-size: 0.9em; font-weight: bold; margin-bottom: 5px; color: var(--text-on-dark);">Complexion (Optional)</p>
                <div id="complexion-options-group" class="filter-options-group">
                    <div class="complexion-tile" style="background-color: #F8D7BE;" data-complexion="Light" data-complexion-code="default"></div>
                    <div class="complexion-tile" style="background-color: #D6A476;" data-complexion="Medium" data-complexion-code="default"></div>
                    <div class="complexion-tile" style="background-color: #A97A52;" data-complexion="Dark" data-complexion-code="ds"></div>
                    <div class="complexion-tile" style="background-color: #6A3E26;" data-complexion="Deep" data-complexion-code="ds"></div>
                </div>
            </div>
        </div>
        
        <div id="central-section">
            <div id="central-viewport">
                <div id="camera-placeholder-icon">
                </div>
                
                <video id="video-feed" autoplay playsinline></video>
                <img id="ai-result" style="display: none;" src="" alt="AI Hairstyle Result">
                <p id="status-message">Tap the silhouette above to take a selfie.</p>
            </div>
        </div>
        
        <div id="controls-footer-row">
            <button id="camera-capture-btn" class="circular-action-btn main-action-btn" disabled>ðŸ“¸</button> 
            <button id="redo-selfie-btn" class="circular-action-btn main-action-btn" style="display: none;">ðŸ”„</button>
            <button id="generate-look-btn" class="circular-action-btn main-action-btn" style="display: none;">âœ¨</button>
            <div id="loading-spinner" class="spinner" style="display: none;"></div>
            <button id="book-appointment-btn" class="main-action-btn" style="display: none;">Book Appointment</button>
        </div>

        <div id="style-inspiration-section">
            <p>Get the Look</p>
            
            <div id="male-hairstyle-options-group" class="hairstyle-options-group-wrapper">
                </div>
            
            <div id="female-hairstyle-options-group" class="hairstyle-options-group-wrapper" style="display: none;">
                
                <div class="style-option" data-prompt="A shoulder-length cut with soft waves and natural volume, warm brunette color, gentle face-framing layers.">
                    <img class="style-thumbnail" src="styles/female/style1.png" alt="Soft Wavy Layers">
                    <p>Soft Wavy Layers</p>
                </div>
                <div class="style-option" data-prompt="A long layered hairstyle with loose curls, dark brown color, flowing and romantic silhouette.">
                    <img class="style-thumbnail" src="styles/female/style2.png" alt="Long Loose Curls">
                    <p>Long Loose Curls</p>
                </div>
                <div class="style-option" data-prompt="A sleek straight bob cut at chin length, jet black color, sharp and modern profile.">
                    <img class="style-thumbnail" src="styles/female/style3.png" alt="Sleek Chin Bob">
                    <p>Sleek Chin Bob</p>
                </div>
                <div class="style-option" data-prompt="A textured lob with subtle waves, ash blonde color, effortless and airy finish.">
                    <img class="style-thumbnail" src="styles/female/style4.png" alt="Textured Wavy Lob">
                    <p>Textured Wavy Lob</p>
                </div>
                <div class="style-option" data-prompt="A short pixie cut with choppy layers, platinum blonde color, bold and edgy look.">
                    <img class="style-thumbnail" src="styles/female/style5.png" alt="Choppy Pixie Cut">
                    <p>Choppy Pixie Cut</p>
                </div>
                <div class="style-option" data-prompt="A long haircut with smooth straight strands, rich chestnut color, polished and elegant feel.">
                    <img class="style-thumbnail" src="styles/female/style6.png" alt="Long Sleek Layers">
                    <p>Long Sleek Layers</p>
                </div>
                <div class="style-option" data-prompt="A curly shoulder-length style with defined ringlets, deep black color, lively and full shape.">
                    <img class="style-thumbnail" src="styles/female/style7.png" alt="Defined Curly Cut">
                    <p>Defined Curly Cut</p>
                </div>
                <div class="style-option" data-prompt="A layered shag cut with curtain bangs, honey brown color, relaxed and trendy vibe.">
                    <img class="style-thumbnail" src="styles/female/style8.png" alt="Layered Shag Cut">
                    <p>Layered Shag Cut</p>
                </div>
                <div class="style-option" data-prompt="A blunt cut with long straight hair, cool dark brown color, clean and minimalist outline.">
                    <img class="style-thumbnail" src="styles/female/style9.png" alt="Blunt Long Cut">
                    <p>Blunt Long Cut</p>
                </div>
                <div class="style-option" data-prompt="A medium-length wavy cut with beachy texture, sandy blonde color, soft and casual movement.">
                    <img class="style-thumbnail" src="styles/female/style10.png" alt="Beachy Waves">
                    <p>Beachy Waves</p>
                </div>
                <div class="style-option" data-prompt="A short bob with flipped-out ends, caramel brown color, playful and retro-inspired shape.">
                    <img class="style-thumbnail" src="styles/female/style11.png" alt="Flipped Bob">
                    <p>Flipped Bob</p>
                </div>
                <div class="style-option" data-prompt="A long hairstyle with voluminous waves, golden blonde color, glamorous and flowing look.">
                    <img class="style-thumbnail" src="styles/female/style12.png" alt="Voluminous Waves">
                    <p>Voluminous Waves</p>
                </div>
                <div class="style-option" data-prompt="A cropped pixie with tapered sides, silver blonde color, sharp and confident style.">
                    <img class="style-thumbnail" src="styles/female/style13.png" alt="Tapered Pixie">
                    <p>Tapered Pixie</p>
                </div>
                <div class="style-option" data-prompt="A medium-length straight cut with subtle layers, natural black color, smooth and balanced profile.">
                    <img class="style-thumbnail" src="styles/female/style14.png" alt="Straight Medium Cut">
                    <p>Straight Medium Cut</p>
                </div>
                <div class="style-option" data-prompt="A long curly style with layered volume, auburn brown color, soft and expressive texture.">
                    <img class="style-thumbnail" src="styles/female/style15.png" alt="Layered Curly Long">
                    <p>Layered Curly Long</p>
                </div>
                <div class="style-option" data-prompt="An asymmetrical bob with one side longer, dark espresso color, modern and fashion-forward feel.">
                    <img class="style-thumbnail" src="styles/female/style16.png" alt="Asymmetrical Bob">
                    <p>Asymmetrical Bob</p>
                </div>
                <div class="style-option" data-prompt="A shoulder-length cut with feathered layers, light brown color, airy and lightweight finish.">
                    <img class="style-thumbnail" src="styles/female/style17.png" alt="Feathered Layers">
                    <p>Feathered Layers</p>
                </div>
                <div class="style-option" data-prompt="A sleek high ponytail with smooth strands, dark brown color, clean and lifted silhouette.">
                    <img class="style-thumbnail" src="styles/female/style18.png" alt="Sleek High Ponytail">
                    <p>Sleek High Ponytail</p>
                </div>
                <div class="style-option" data-prompt="A half-up hairstyle with loose waves, soft brunette color, romantic and relaxed look.">
                    <img class="style-thumbnail" src="styles/female/style19.png" alt="Half-Up Waves">
                    <p>Half-Up Waves</p>
                </div>
                <div class="style-option" data-prompt="A braided crown hairstyle with loose tendrils, warm brown color, delicate and elegant detail.">
                    <img class="style-thumbnail" src="styles/female/style20.png" alt="Braided Crown">
                    <p>Braided Crown</p>
                </div>
                <div class="style-option" data-prompt="A long straight hairstyle with blunt bangs, deep black color, bold and striking contrast.">
                    <img class="style-thumbnail" src="styles/female/style21.png" alt="Blunt Bangs Long">
                    <p>Blunt Bangs Long</p>
                </div>
                
            </div>

        </div>

    </div> <canvas id="hidden-canvas" style="display: none;"></canvas>

    <div id="booking-modal-overlay" class="modal-overlay">
        <div class="booking-modal">
            <button class="modal-close-btn" id="modal-close-btn">&times;</button>
            <h2>Book Your Look</h2>
            <div class="modal-content">
                <p>You are booking the style reference below:</p>
                <img id="reference-image-preview" src="" alt="AI Generated Style Reference">
                <p style="font-size: 0.8em; margin-top: 5px; color: #555;">**Style Selected: <span id="selected-style-name"></span>**</p>
                
                <form id="booking-form">
                    <label for="name">Your Name</label>
                    <input type="text" id="name" name="name" required>

                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required>

                    <label for="date">Select Date</label>
                    <input type="date" id="date" name="date" required>

                    <label for="time">Select Time</label>
                    <select id="time" name="time" required>
                        <option value="">Loading availability...</option>
                    </select>

                    <button type="submit" class="submit-btn" disabled>Confirm Booking</button>
                    <p id="booking-status-message" style="margin-top: 10px; color: #dc3545; font-weight: bold;"></p>
                </form>
            </div>
        </div>
    </div>
    <script>
// NOTE: The entire JavaScript block is UNCHANGED from the last version.
// All functionality (camera, style filtering, randomization, button visibility) 
// is fully preserved because the CSS only targets the look and feel.

document.addEventListener('DOMContentLoaded', () => {
    // 1. Get DOM elements
    const videoFeed = document.getElementById('video-feed');
    const aiResultImg = document.getElementById('ai-result');
    const canvas = document.getElementById('hidden-canvas');
    const cameraPlaceholderIcon = document.getElementById('camera-placeholder-icon');

    // NEW BUTTONS AND CONTROLS
    const cameraCaptureBtn = document.getElementById('camera-capture-btn');
    const redoSelfieBtn = document.getElementById('redo-selfie-btn');
    const generateLookBtn = document.getElementById('generate-look-btn');
    const bookAppointmentBtn = document.getElementById('book-appointment-btn'); 
    const spinner = document.getElementById('loading-spinner');
    const statusMessage = document.getElementById('status-message');

    // Filter elements
    const filtersAccordion = document.getElementById('additional-filters-selector');
    const complexionGroup = document.getElementById('complexion-options-group');
    
    // References to all style groups
    const maleStyleOptionsGroup = document.getElementById('male-hairstyle-options-group');
    const femaleStyleOptionsGroup = document.getElementById('female-hairstyle-options-group');
    
    // Gender buttons
    const maleGenderBtn = document.getElementById('male-gender-btn');
    const femaleGenderBtn = document.getElementById('female-gender-btn');
    
    // NEW MODAL ELEMENTS
    const bookingModalOverlay = document.getElementById('booking-modal-overlay');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const bookingForm = document.getElementById('booking-form');
    const referenceImagePreview = document.getElementById('reference-image-preview');
    const selectedStyleNameSpan = document.getElementById('selected-style-name');

    // State tracking variables
    let capturedImageBase64 = null;
    let selectedPrompt = null;
    let selectedStyleLabel = null; 
    let cameraStarted = false;
    let selectedGender = 'Male';
    let selectedComplexionCode = null; // Stores 'default', 'ds', etc.
    let imageCaptured = false;
    let aiGenerationComplete = false; 

    // --- CONSTANTS ---
    const NEGATIVE_PROMPT = "extra fingers, blurry, low resolution, bad hands, deformed face, mask artifact, bad blending, unnatural hair hair color, ugly, tiling, duplicate, abstract, cartoon, distorted pupils, bad lighting, cropped, grainy, noise, poor lighting, poor composition, low quality, changed clothing, changed background, new outfit, new background, different lighting";

    // --- CONSOLIDATED MALE STYLE DATA ---
    // This array holds ALL male styles for randomization and filtering
    const ALL_MALE_STYLES = [
        // Default Skin Styles (for Light/Medium complexions)
        { code: 'default', src: "styles/male/style1.png", label: "Tousled Short Crop", prompt: "A short haircut with a tousled and textured top, dark brown color, sharp side profile." },
        { code: 'default', src: "styles/male/style2.png", label: "Wavy Clean Fade", prompt: "A clean fade with a slightly messy wavy top, medium brown color, defined jawline framing" },
        { code: 'default', src: "styles/male/style3.png", label: "Classic Side-Part", prompt: "A classic side-part with a smooth combed finish, ash black color, crisp temple blend." },
        { code: 'default', src: "styles/male/style4.png", label: "Curly Short Crop", prompt: "A short curly crop with tight texture, deep black color, taper fade around the ears." },
        { code: 'default', src: "styles/male/style5.png", label: "Layered Shag Cut", prompt: "A medium-length shag with layered volume, chestnut brown color, soft silhouette." },
        { code: 'default', src: "styles/male/style6.png", label: "Textured Buzz", prompt: "A buzz cut with subtle texture on top, dark blonde color, strong and structured profile." },
        { code: 'default', src: "styles/male/style7.png", label: "Modern Quiff", prompt: "A modern quiff with height and soft edges, dark brown color, low fade on the sides." },
        { code: 'default', src: "styles/male/style8.png", label: "Textured Fringe", prompt: "A textured fringe with choppy layers, sandy brown color, relaxed and youthful feel." },
        { code: 'default', src: "styles/male/style9.png", label: "Wavy Slick-Back", prompt: "A slick-back style with slight wave, espresso black color, clean undercut detail." },
        { code: 'default', src: "styles/male/style10.png", label: "Caesar Crop", prompt: "A cropped Caesar cut with short bangs, warm brown color, sharp and tidy shape." },
        { code: 'default', src: "styles/male/style11.png", label: "Swept-Back Medium", prompt: "A medium-length swept-back style with natural flow, golden brown color, tapered sides." },
        { code: 'default', src: "styles/male/style12.png", label: "Curly Undercut", prompt: "A curly undercut with defined top volume, jet black color, bold contrast in lengths." },
        { code: 'default', src: "styles/male/style13.png", label: "Messy Medium Crop", prompt: "A messy medium crop with subtle waves, chocolate brown color, soft shadow fade." },
        { code: 'default', src: "styles/male/style14.png", label: "Spiky Short Fade", prompt: "A spiky short top with controlled texture, dark brown color, sharp high fade." },
        { code: 'default', src: "styles/male/style15.png", label: "Forward Brush Cut", prompt: "A long top with brushed-forward texture, deep mahogany color, tight sides for structure." },
        { code: 'default', src: "styles/male/style16.png", label: "Textured Buzz Fade", prompt: "A low-maintenance textured buzz with slight stubble blend, dark ash brown color." },
        { code: 'default', src: "styles/male/style17.png", label: "Smooth Pompadour", prompt: "A voluminous pompadour with smooth finish, black-brown color, clean and polished sides." },
        { code: 'default', src: "styles/male/style18.png", label: "Surfer Waves", prompt: "A relaxed surfer-style wave with medium length, sandy blonde color, natural movement." },
        { code: 'default', src: "styles/male/style19.png", label: "High-Contrast Crop", prompt: "A detailed crop with high contrast fade, smoky black color, strong forehead line." },
        { code: 'default', src: "styles/male/style20.png", label: "Layered Side Sweep", prompt: "A medium layered cut with side sweep, warm auburn brown color, gentle taper." },
        { code: 'default', src: "styles/male/style21.png", label: "Modern Mullet", prompt: "A modern mullet with short front and layered back flow, dark charcoal color, bold silhouette." },
        
        // Dark Skin Styles (for Dark/Deep complexions)
        { code: 'ds', src: "styles/male/ds/1.png", label: "Low Fade Coils", prompt: "A low fade with short tight coils on top, natural black color, clean hairline finish." },
        { code: 'ds', src: "styles/male/ds/2.png", label: "Classic Afro", prompt: "A classic afro with rounded shape, dense texture, bold and balanced silhouette." },
        { code: 'ds', src: "styles/male/ds/3.png", label: "Short Twists Fade", prompt: "Short twists with a taper fade, deep black color, neat and modern profile." },
        { code: 'ds', src: "styles/male/ds/4.png", label: "Wave Crop", prompt: "A cropped cut with waves brushed forward, jet black color, sharp temple lines." },
        { code: 'ds', src: "styles/male/ds/5.png", label: "High-Top Fade", prompt: "A high-top fade with structured volume, natural black color, strong vertical shape." },
        { code: 'ds', src: "styles/male/ds/6.png", label: "Clean Buzz Cut", prompt: "A buzz cut with precise edge-up, dark black color, minimal and clean look." },
        { code: 'ds', src: "styles/male/ds/7.png", label: "Pulled-Back Locs", prompt: "Medium-length locs pulled back, natural black color, relaxed and confident style." },
        { code: 'ds', src: "styles/male/ds/8.png", label: "Sponge Curl Fade", prompt: "A short curly fade with sponge-textured top, dense coils, smooth side blend." },
        { code: 'ds', src: "styles/male/ds/9.png", label: "Straight Cornrows", prompt: "Cornrow braids with straight-back pattern, natural black color, clean scalp lines." },
        { code: 'ds', src: "styles/male/ds/10.png", label: "Tapered Afro", prompt: "A tapered afro with controlled volume, matte black color, soft rounded outline." },
        { code: 'ds', src: "styles/male/ds/11.png", label: "Curly Frohawk", prompt: "A short frohawk with faded sides, tight curls, bold center emphasis." },
        { code: 'ds', src: "styles/male/ds/12.png", label: "Finger Coils", prompt: "Defined finger coils with low taper, black color, glossy textured finish." },
        { code: 'ds', src: "styles/male/ds/13.png", label: "Bald Fade Curls", prompt: "A bald fade with very short, naturally lying curls on top, dark black tone, crisp contrast." },
        { code: 'ds', src: "styles/male/ds/14.png", label: "Freeform Locs", prompt: "Freeform locs with medium length, natural texture, organic silhouette." },
        { code: 'ds', src: "styles/male/ds/15.png", label: "Burst Fade Curls", prompt: "A burst fade with curly top, black color, rounded side profile." },
        { code: 'ds', src: "styles/male/ds/16.png", label: "Short Box Braids", prompt: "Short box braids with neat parting, dark black color, uniform structure." },
        { code: 'ds', src: "styles/male/ds/17.png", label: "Flat Brush Cut", prompt: "A flat brush cut with subtle wave pattern, jet black color, sharp geometry." },
        { code: 'ds', src: "styles/male/ds/18.png", label: "Short Afro Crop", prompt: "A short afro crop with even density, natural black tone." }
    ];

    // --- Helper Functions ---

    /**
     * Fisher-Yates (Knuth) Shuffle algorithm.
     * @param {Array} array - The array to shuffle.
     * @returns {Array} - The shuffled array.
     */
    function shuffle(array) {
        let currentIndex = array.length, randomIndex;
        while (currentIndex !== 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
        }
        return array;
    }
    
    function createStyleElement(style) {
        const div = document.createElement('div');
        div.className = 'style-option';
        div.dataset.prompt = style.prompt;
        div.dataset.complexionCode = style.code; // Store the filter code
        
        const img = document.createElement('img');
        img.className = 'style-thumbnail';
        img.src = style.src;
        img.alt = style.label;
        
        const p = document.createElement('p');
        p.textContent = style.label;

        div.appendChild(img);
        div.appendChild(p);
        
        div.addEventListener('click', () => handleStyleSelect(div));
        return div;
    }
    
    /**
     * Renders a list of style objects into the specified container.
     * @param {HTMLElement} container - The gallery wrapper.
     * @param {Array<Object>} stylesArray - The array of style objects to render.
     */
    function renderStyles(container, stylesArray) {
        container.innerHTML = ''; // Clear existing styles
        stylesArray.forEach(style => {
            container.appendChild(createStyleElement(style));
        });

        // Set up scroll listeners after content is rendered
        setupScrollListeners(container);
    }

    // New: Function to handle filtering and rendering for male styles
    function updateMaleStyleGallery(filterCode = null) {
        let filteredStyles;
        
        if (filterCode) {
            // Filter mode: Show only styles matching the selected code
            filteredStyles = ALL_MALE_STYLES.filter(style => style.code === filterCode);
        } else {
            // Default mode: Show ALL male styles in random order
            filteredStyles = ALL_MALE_STYLES;
        }

        // Shuffle the results before rendering
        const shuffledStyles = shuffle([...filteredStyles]);
        
        // Render the filtered/shuffled list
        renderStyles(maleStyleOptionsGroup, shuffledStyles);
        
        // Since the gallery content changed, reset prompt state and visibility
        selectedPrompt = null;
        selectedStyleLabel = null;
        updateButtonVisibility();
        
        // Scroll to start after rendering
        maleStyleOptionsGroup.scrollLeft = 0;
    }

    // Existing functions (minor updates)

    function updateButtonVisibility() {
        // Reset all buttons
        cameraCaptureBtn.style.display = 'none';
        redoSelfieBtn.style.display = 'none';
        generateLookBtn.style.display = 'none';
        bookAppointmentBtn.style.display = 'none'; 
        spinner.style.display = 'none';

        if (spinner.classList.contains('active')) {
            // Processing State
            spinner.style.display = 'block';
        } else if (aiGenerationComplete) {
            // AI Complete State
            redoSelfieBtn.style.display = 'flex'; 
            bookAppointmentBtn.style.display = 'flex'; 
            statusMessage.textContent = `Success! Your new look is ready. Book an appointment or click ðŸ”„ to redo.`;
        } else if (imageCaptured) {
            // Image Captured State
            redoSelfieBtn.style.display = 'flex'; 
            if (selectedPrompt) {
                generateLookBtn.style.display = 'flex'; 
                generateLookBtn.disabled = false;
                const complexionStatus = selectedComplexionCode ? `(Complexion Filter Active)` : '';
                statusMessage.textContent = `Style selected: ${selectedStyleLabel}. Click âœ¨ to generate ${complexionStatus}.`;
            } else {
                statusMessage.textContent = "Image captured. Select a hairstyle to unlock the 'Generate' button.";
            }
        } else {
            // Camera/Initial State
            cameraCaptureBtn.style.display = 'flex';
            cameraCaptureBtn.disabled = !cameraStarted; 
            if (cameraStarted) {
                statusMessage.textContent = "Adjust your face in the box, then click ðŸ“¸ to capture.";
            } else {
                statusMessage.textContent = "Tap the silhouette above to take a selfie"; 
            }
        }
    }
    
    function findClosestToCenter(scrollContainer, styleOptions) {
        // ... (No changes needed to this helper logic) ...
        const containerCenter = scrollContainer.scrollLeft + (scrollContainer.clientWidth / 2);
        let closestOption = null;
        let minDifference = Infinity;

        styleOptions.forEach(option => {
            const optionCenter = option.offsetLeft + (option.offsetWidth / 2);
            const difference = Math.abs(optionCenter - containerCenter);

            if (difference < minDifference) {
                minDifference = difference;
                closestOption = option;
            }
        });

        return closestOption;
    }

    function updateStyleSelectionOnScroll(scrollContainer, allOptions) {
        // Only run if the current container is visible
        if (scrollContainer.style.display === 'none') return;
        
        const closestOption = findClosestToCenter(scrollContainer, allOptions);

        if (closestOption) {
             // 1. Visually select the centered option
            if (!closestOption.classList.contains('selected')) {
                allOptions.forEach(o => o.classList.remove('selected'));
                closestOption.classList.add('selected');
            }
            
            // 2. Update the internal state 
            if (selectedPrompt !== closestOption.dataset.prompt) {
                selectedPrompt = closestOption.dataset.prompt;
                // Use dataset.prompt as the fallback label
                selectedStyleLabel = closestOption.querySelector('p').textContent || closestOption.dataset.prompt; 
                updateButtonVisibility(); 
            }
        }
    }

    const setupScrollListeners = (groupWrapper) => {
        // Need to get the children *after* content is rendered by renderStyles
        const allOptions = groupWrapper.querySelectorAll('.style-option');
        if (allOptions.length === 0) return;

        const scrollHandler = () => {
            updateStyleSelectionOnScroll(groupWrapper, allOptions);
        };

        const oldHandler = groupWrapper._scrollHandler;
        if (oldHandler) {
            groupWrapper.removeEventListener('scroll', oldHandler);
        }

        groupWrapper.addEventListener('scroll', scrollHandler);
        
        groupWrapper._scrollHandler = scrollHandler;
        
        // Force initial selection after content is rendered
        scrollHandler(); 
    };

    function handleGenderSelect(gender) {
        // Reset complexion selection when switching gender
        selectedComplexionCode = null;
        complexionGroup.querySelectorAll('.complexion-tile').forEach(t => t.classList.remove('selected'));
        
        selectedGender = gender;
        
        maleGenderBtn.classList.remove('selected');
        femaleGenderBtn.classList.remove('selected');
        
        if (gender === 'Male') {
            maleGenderBtn.classList.add('selected');
            maleStyleOptionsGroup.style.display = 'flex';
            femaleStyleOptionsGroup.style.display = 'none';
            filtersAccordion.style.display = 'block';
            
            // Initial render of randomized male styles
            updateMaleStyleGallery(null); 
            
        } else if (gender === 'Female') {
            femaleGenderBtn.classList.add('selected');
            maleStyleOptionsGroup.style.display = 'none';
            femaleStyleOptionsGroup.style.display = 'flex';
            filtersAccordion.style.display = 'none';
            
            // Female styles are static for now, re-apply scroll listener
            setupScrollListeners(femaleStyleOptionsGroup);
        }
        
        // Reset image state if a switch occurred
        if (imageCaptured) resetSession();
    }
    
    function toggleFilterSection(section) {
        if (section.classList.contains('collapsed')) {
            section.classList.remove('collapsed');
            section.classList.add('expanded');
        } else {
            section.classList.remove('expanded');
            section.classList.add('collapsed');
        }
    }

    // MODIFIED: Function to handle complexion selection and filtering
    function handleComplexionSelect(tile) {
        if (selectedGender !== 'Male') return;
        
        const isSelected = tile.classList.contains('selected');
        const complexionTiles = complexionGroup.querySelectorAll('.complexion-tile');
        const code = tile.dataset.complexionCode;

        // Clear previous selection
        complexionTiles.forEach(t => t.classList.remove('selected'));
        
        let newFilterCode = null;

        if (!isSelected) {
            tile.classList.add('selected');
            newFilterCode = code; 
        } 
        
        selectedComplexionCode = newFilterCode;
        
        // Update the visible style gallery by filtering the main list
        updateMaleStyleGallery(selectedComplexionCode);
    }
    
    // Click handler to scroll the clicked item into the center
    function handleStyleSelect(styleOption) {
        const scrollContainer = styleOption.closest('.hairstyle-options-group-wrapper');
        if (scrollContainer) {
            const containerWidth = scrollContainer.clientWidth;
            const optionWidth = styleOption.offsetWidth;
            const scrollTarget = styleOption.offsetLeft - (containerWidth / 2) + (optionWidth / 2);
            
            scrollContainer.scrollTo({
                left: scrollTarget,
                behavior: 'smooth'
            });
        }
    }

    // --- Camera Functions (No changes needed) ---
    async function startCamera() {
        if (cameraStarted) return; 
        statusMessage.textContent = "Requesting camera access...";
        cameraCaptureBtn.disabled = true;

        try {
            const constraints = {
                video: {
                    facingMode: 'user', 
                    width: { ideal: 250 },
                    height: { ideal: 250 }
                }
            };
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            videoFeed.srcObject = stream;
            
            await new Promise(resolve => {
                videoFeed.onloadedmetadata = () => {
                    videoFeed.play();
                    resolve();
                };
            });

            cameraStarted = true;
            imageCaptured = false;
            aiGenerationComplete = false; 

            cameraPlaceholderIcon.style.display = 'none'; 
            aiResultImg.style.display = 'none';
            videoFeed.style.display = 'block'; 

            updateButtonVisibility();
        } catch (error) {
            console.error('Error accessing camera:', error);
            statusMessage.textContent = `Error: Cannot start camera. Check permissions/device settings. (${error.name})`;
            cameraPlaceholderIcon.style.display = 'block';
            videoFeed.style.display = 'none';
            cameraStarted = false;
            updateButtonVisibility(); 
        }
    }

    function stopCamera() {
        if (videoFeed.srcObject) {
            videoFeed.srcObject.getTracks().forEach(track => track.stop());
            videoFeed.srcObject = null;
        }
        cameraStarted = false;
    }

    function captureImage() {
        if (!cameraStarted) return;

        const context = canvas.getContext('2d');
        const width = videoFeed.videoWidth || 250; 
        const height = videoFeed.videoHeight || 250;

        canvas.width = width;
        canvas.height = height;
        context.drawImage(videoFeed, 0, 0, width, width); 

        const fullDataURL = canvas.toDataURL('image/jpeg');
        const parts = fullDataURL.split(',');
        capturedImageBase64 = parts.length > 1 ? parts[1] : fullDataURL;

        imageCaptured = true;
        aiGenerationComplete = false; 

        videoFeed.style.display = 'none';
        aiResultImg.style.display = 'block';
        aiResultImg.src = fullDataURL; 

        stopCamera();
        updateButtonVisibility();
    }

    function resetSession() {
        stopCamera();
        aiResultImg.style.display = 'none';
        cameraPlaceholderIcon.style.display = 'block';
        imageCaptured = false;
        aiGenerationComplete = false; 
        capturedImageBase64 = null;
        spinner.classList.remove('active');

        // Re-render the current style gallery to reset selection
        if(selectedGender === 'Male') {
            updateMaleStyleGallery(selectedComplexionCode);
        } else {
            setupScrollListeners(femaleStyleOptionsGroup);
        }

        filtersAccordion.classList.remove('expanded');
        filtersAccordion.classList.add('collapsed');

        updateButtonVisibility();
    }

    // --- Button Event Listeners (No changes needed) ---

    cameraCaptureBtn.addEventListener('click', captureImage);
    cameraPlaceholderIcon.addEventListener('click', () => {
        if (!cameraStarted && !imageCaptured) {
            startCamera();
        }
    });
    redoSelfieBtn.addEventListener('click', () => {
        resetSession();
        startCamera(); 
    });

    generateLookBtn.addEventListener('click', async () => {
        if (!capturedImageBase64 || !selectedPrompt) {
            statusMessage.textContent = "Please capture a selfie and select a hairstyle first.";
            return;
        }

        spinner.classList.add('active');
        updateButtonVisibility();
        statusMessage.textContent = "Uploading image and defining style...";

        const complexionClause = selectedComplexionCode
            ? ` with a ${selectedComplexionCode === 'ds' ? 'darkest' : 'standard'} complexion`
            : ``;

        const finalPrompt = `STRICTLY operate in an inpainting/editing mode. The ONLY element to be changed is the subject's hair. PRESERVE the subject's face, identity, expression, clothing, and background EXACTLY as they appear in the original photograph. Apply the following hairstyle, matching its texture, color, and shape: ${selectedPrompt}. The final result must be a high quality, professional studio portrait of a ${selectedGender} model${complexionClause} with NO other changes besides the hair.`;

        try {
            statusMessage.textContent = "Processing your new look"; 
            const response = await fetch('/api/run_model', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    baseImage: capturedImageBase64,
                    prompt: finalPrompt,
                    negativePrompt: NEGATIVE_PROMPT 
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
            }

            const data = await response.json();

            aiResultImg.src = `data:image/jpeg;base64,${data.generatedImageBase64}`;
            aiResultImg.style.display = 'block';
            videoFeed.style.display = 'none';
            cameraPlaceholderIcon.style.display = 'none';

            aiGenerationComplete = true; 
            imageCaptured = true; 
            capturedImageBase64 = data.generatedImageBase64; 
            
            spinner.classList.remove('active');
            updateButtonVisibility();

        } catch (error) {
            console.error('AI Processing Error:', error);
            statusMessage.textContent = `Error during AI try-on: ${error.message}. Please check console and retry.`;
            spinner.classList.remove('active');
            updateButtonVisibility();
        }
    });

    bookAppointmentBtn.addEventListener('click', () => {
        if (!aiGenerationComplete) {
            statusMessage.textContent = "Please generate a look first before booking.";
            return;
        }

        referenceImagePreview.src = aiResultImg.src;
        selectedStyleNameSpan.textContent = selectedStyleLabel;
        bookingModalOverlay.classList.add('visible');
    });

    modalCloseBtn.addEventListener('click', () => {
        bookingModalOverlay.classList.remove('visible');
    });

    bookingForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const bookingStatusMessage = document.getElementById('booking-status-message');
        const submitButton = bookingForm.querySelector('.submit-btn');

        submitButton.textContent = "Processing...";
        submitButton.disabled = true;
        bookingStatusMessage.style.color = '#ffc107';
        bookingStatusMessage.textContent = "Connecting to scheduling service...";
        
        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        const date = document.getElementById('date').value;
        const time = document.getElementById('time').value;

        const bookingData = {
            firstName: name.split(' ')[0] || '',
            lastName: name.split(' ').slice(1).join(' ') || '',
            email: email,
            datetime: `${date}T${time}:00`,
            appointmentType: selectedGender === 'Male' ? 'Men\'s Cut' : 'Women\'s Cut', 
            styleName: selectedStyleLabel,
            stylePrompt: selectedPrompt,
            imageReference: aiResultImg.src, 
        };
        
        console.log("Booking data prepared:", bookingData);

        setTimeout(() => {
            bookingStatusMessage.style.color = 'var(--highlight-color)'; 
            bookingStatusMessage.textContent = "Booking Confirmed! Check your email for details.";
            submitButton.textContent = "Confirmed!";
        }, 2000); 
    });


    // --- INITIALIZATION and EVENT LISTENERS ---
    function initialize() {
        // Gender Button Listeners
        if (maleGenderBtn) {
            maleGenderBtn.addEventListener('click', () => handleGenderSelect('Male'));
        }

        if (femaleGenderBtn) {
            femaleGenderBtn.addEventListener('click', () => handleGenderSelect('Female'));
        }

        // Filter Listeners
        if (filtersAccordion) {
            filtersAccordion.querySelector('h3').addEventListener('click', () => toggleFilterSection(filtersAccordion));
            filtersAccordion.classList.add('collapsed');
        }

        if (complexionGroup) {
            complexionGroup.querySelectorAll('.complexion-tile').forEach(tile => {
                tile.addEventListener('click', () => handleComplexionSelect(tile));
            });
        }
        
        // **INITIAL STATE: Select Male and Render All Styles Randomized**
        handleGenderSelect('Male');
    }

    initialize();
});
    </script>
</body>
</html>
