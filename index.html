<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hairstyle Virtual Try-On</title>
    
    <style>
/* --- Global Colors --- */
/* ... (Styles are unchanged and omitted for brevity) ... */

:root {
    --primary-color: #1D2124; 
    --text-on-dark: #FFFFFF; 
    --background-color: #f4f7f6;
    --text-color: #333; 
    --highlight-color: #28a745; 
    --thumbnail-size: 60px;
    --gallery-gap: 10px; 
    --header-height: 40px;
    --viewport-size-desktop: 300px; 
    --viewport-size-mobile: 250px; 
    --content-max-width: 400px; 
}

body {
    font-family: Arial, sans-serif;
    background-color: var(--background-color);
    color: var(--text-color);
    margin: 0;
    padding: 0; 
    text-align: center;
    -webkit-user-select: none;
    user-select: none;
    overflow-x: hidden; 
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

/* --- Header and Logo Styling (MINIMAL BANNER) --- */
#app-header {
    padding: 0; 
    background-color: #FFFFFF;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); 
    height: var(--header-height); 
    display: flex;
    align-items: center;
    justify-content: center;
    position: sticky; 
    top: 0;
    z-index: 100;
}
#main-logo {
    max-width: 100px !important; 
    height: 35px !important; 
    object-fit: contain; 
}

/* ... (Rest of the CSS is unchanged and omitted for brevity) ... */
    </style>
</head>
<body>
    <div id="app-header">
        <img id="main-logo" src="assets/Minimalist 'Looks' Logo with Hair Strand Design (1).png" alt="Looks Logo">
    </div>

    <div id="main-app-container">
        
        <div class="gender-buttons-container">
            <button id="male-gender-btn" class="gender-button">Male</button>
            <button id="female-gender-btn" class="gender-button">Female</button>
        </div>

        <div id="central-section">
            <div id="central-viewport">
                <video id="video-feed" autoplay playsinline></video>
                <img id="ai-result" style="display: none;" src="" alt="AI Hairstyle Result">
                <p id="status-message">Click the Play button to start your camera.</p>
            </div>
            
            <div id="controls">
                <button id="take-selfie-btn" class="main-action-btn">‚ñ∂Ô∏è</button>
                <div id="loading-spinner" class="spinner"></div>
            </div>
        </div>


        <div id="filter-section-wrapper">
            
            <div id="complexion-selector" class="filter-section collapsed">
                <h3><span>Complexion (Optional)</span><span class="icon"></span></h3>
                <div class="filter-content-group">
                    <div id="complexion-options-group" class="filter-options-group">
                        <div class="complexion-tile" style="background-color: #F8D7BE;" data-complexion="Light"></div>
                        <div class="complexion-tile" style="background-color: #D6A476;" data-complexion="Medium"></div>
                        <div class="complexion-tile" style="background-color: #A97A52;" data-complexion="Dark"></div>
                        <div class="complexion-tile" style="background-color: #6A3E26;" data-complexion="Deep"></div>
                    </div>
                </div>
            </div>

            <div id="hairstyle-gallery" class="filter-section expanded">
                <h3><span>Hairstyle Inspiration</span><span class="icon"></span></h3>
                <div class="filter-content-group">
                    <div class="filter-options-group">
                        
                        <div class="style-option" data-prompt="a slicked-back undercut with brushed up blonde hair">
                            <img class="style-thumbnail" src="styles/brushed up blonde.jpeg" alt="Brushed Up Blonde">
                            <p>Brushed Up Blonde</p>
                        </div>
                        
                        <div class="style-option" data-prompt="a short cut with a heavy forward fringe">
                            <img class="style-thumbnail" src="styles/forward fringe.jpeg" alt="Forward Fringe">
                            <p>Forward Fringe</p>
                        </div>
                        
                        <div class="style-option" data-prompt="a classic high top fade with sharp lines">
                            <img class="style-thumbnail" src="styles/high top fade.jpeg" alt="High Top Fade">
                            <p>High Top Fade</p>
                        </div>
                        
                        <div class="style-option" data-prompt="a voluminous hairstyle with natural curls">
                            <img class="style-thumbnail" src="styles/natural curls.jpeg" alt="Natural Curls">
                            <p>Natural Curls</p>
                        </div>
                        
                        <div class="style-option" data-prompt="a clean side swept scissor cut">
                            <img class="style-thumbnail" src="styles/side swept scissor cut.jpeg" alt="Side Swept Scissor Cut">
                            <p>Side Swept Scissor Cut</p>
                        </div>
                        
                        <div class="style-option" data-prompt="a sleek, formal side part style">
                            <img class="style-thumbnail" src="styles/sleek side part.jpeg" alt="Sleek Side Part">
                            <p>Sleek Side Part</p>
                        </div>
                        
                        <div class="style-option" data-prompt="a fun, short spiked hairstyle">
                            <img class="style-thumbnail" src="styles/spiked charm.jpeg" alt="Spiked Charm">
                            <p>Spiked Charm</p>
                        </div>
                        
                        <div class="style-option" data-prompt="a short haircut with a tousled and textured top">
                            <img class="style-thumbnail" src="styles/tousled top.jpeg" alt="Tousled Top">
                            <p>Tousled Top</p>
                        </div>
                        
                        <div class="style-option" data-prompt="a modern wavy quiff with volume">
                            <img class="style-thumbnail" src="styles/wavy quiff.jpeg" alt="Wavy Quiff">
                            <p>Wavy Quiff</p>
                        </div>
                        
                    </div>
                </div>
            </div>
            
            <button id="try-on-btn" class="main-action-btn" style="display: none;">Generate My New Look</button>

        </div> </div> <canvas id="hidden-canvas" style="display: none;"></canvas>

    <script>
// ... (Script is unchanged and omitted for brevity) ...
document.addEventListener('DOMContentLoaded', () => {
    // 1. Get DOM elements
    const videoFeed = document.getElementById('video-feed');
    const aiResultImg = document.getElementById('ai-result');
    const canvas = document.getElementById('hidden-canvas');
    const centralViewport = document.getElementById('central-viewport');
    
    // Buttons and Controls
    const takeSelfieBtn = document.getElementById('take-selfie-btn');
    const tryOnBtn = document.getElementById('try-on-btn');
    const spinner = document.getElementById('loading-spinner');
    
    const statusMessage = document.getElementById('status-message');
    
    // Filter elements 
    const complexionSelector = document.getElementById('complexion-selector');
    const complexionGroup = document.getElementById('complexion-options-group');
    const galleryContainer = document.getElementById('hairstyle-gallery'); 
    
    // New Gender Buttons
    const maleGenderBtn = document.getElementById('male-gender-btn');
    const femaleGenderBtn = document.getElementById('female-gender-btn');

    // State tracking variables
    let capturedImageBase64 = null; 
    let selectedPrompt = null; 
    let cameraStarted = false; 
    let selectedGender = 'Male'; 
    let selectedComplexion = null; 

    // --- CONSTANTS ---
    const NEGATIVE_PROMPT = "extra fingers, blurry, low resolution, bad hands, deformed face, mask artifact, bad blending, unnatural hair hair color, ugly, tiling, duplicate, abstract, cartoon, distorted pupils, bad lighting, cropped, grainy, noise, poor lighting, poor composition, low quality, changed clothing, changed background, new outfit, new background, different lighting"; 

    // --- Helper Functions ---
    
    function updateTryOnButtonVisibility() {
        if (capturedImageBase64 && selectedPrompt) {
            tryOnBtn.style.display = 'block';
            tryOnBtn.disabled = false;
            if (!statusMessage.textContent.includes('Processing')) {
                 const complexionStatus = selectedComplexion ? `(${selectedComplexion} Complexion selected)` : '(Complexion Auto-Detected)';
                 statusMessage.textContent = `All set! Click 'Generate My New Look' below ${complexionStatus}.`;
            }
        } else {
            tryOnBtn.style.display = 'none';
        }
    }

    function handleGenderSelect(gender) {
        selectedGender = gender;
        maleGenderBtn.classList.remove('selected');
        femaleGenderBtn.classList.remove('selected');
        if (gender === 'Male') {
            maleGenderBtn.classList.add('selected');
        } else if (gender === 'Female') {
            femaleGenderBtn.classList.add('selected');
        }
        updateTryOnButtonVisibility();
    }

    function toggleFilterSection(section) {
        if (section.classList.contains('collapsed')) {
            section.classList.remove('collapsed');
            section.classList.add('expanded');
        } else {
            section.classList.remove('expanded');
            section.classList.add('collapsed');
        }
    }
    
    function handleComplexionSelect(tile) {
        const isSelected = tile.classList.contains('selected');
        const complexionTiles = complexionGroup.querySelectorAll('.complexion-tile');
        
        // Deselect all
        complexionTiles.forEach(t => t.classList.remove('selected'));
        
        if (!isSelected) {
            // Select the clicked tile
            tile.classList.add('selected');
            selectedComplexion = tile.dataset.complexion;
            
        } else {
            // If already selected, clicking it again deselects it
            selectedComplexion = null;
        }
        
        updateTryOnButtonVisibility(); 
    }
    
    function handleStyleSelect(styleOption) {
        const styleOptions = galleryContainer.querySelectorAll('.style-option');
        styleOptions.forEach(o => o.classList.remove('selected'));
        
        styleOption.classList.add('selected'); 
        selectedPrompt = styleOption.dataset.prompt;
        
        updateTryOnButtonVisibility(); 
        
        if (capturedImageBase64) {
             statusMessage.textContent = `Style selected. Click 'Generate' or select a complexion (optional).`;
        }
    }
    
    async function startCamera() {
        try {
            const constraints = { 
                video: {
                    facingMode: 'user', 
                    width: { ideal: 250 }, 
                    height: { ideal: 250 }
                }
            };
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            videoFeed.srcObject = stream;
            cameraStarted = true;
            
            videoFeed.setAttribute('playsinline', '');
            
            centralViewport.classList.add('active'); 
            aiResultImg.style.display = 'none'; 
            videoFeed.style.display = 'block'; 
            
            takeSelfieBtn.textContent = "üì∏"; 
            statusMessage.textContent = "Adjust your face in the box, then click üì∏ to capture.";
            
            tryOnBtn.style.display = 'none';

        } catch (error) {
            console.error('Error accessing camera:', error);
            statusMessage.textContent = `Error: Could not start camera. Check permissions. (${error.name})`;
            
            takeSelfieBtn.textContent = "‚ñ∂Ô∏è";
            centralViewport.classList.remove('active');
        }
    }
    
    function stopCamera() {
        if (videoFeed.srcObject) {
            videoFeed.srcObject.getTracks().forEach(track => track.stop());
            videoFeed.srcObject = null;
        }
        cameraStarted = false;
    }
    
    function captureImage() {
        const context = canvas.getContext('2d');
        const width = videoFeed.videoWidth || centralViewport.offsetWidth;
        const height = videoFeed.videoHeight || centralViewport.offsetHeight;

        canvas.width = width;
        canvas.height = height;
        context.drawImage(videoFeed, 0, 0, width, height);

        const fullDataURL = canvas.toDataURL('image/jpeg');
        
        // CRITICAL FIX: Ensure only the pure base64 string is stored
        const parts = fullDataURL.split(',');
        capturedImageBase64 = parts.length > 1 ? parts[1] : fullDataURL;
        
        videoFeed.style.display = 'none'; 
        aiResultImg.style.display = 'block';
        aiResultImg.src = fullDataURL;
        
        stopCamera();
        
        statusMessage.textContent = "Image captured. Select a hairstyle to unlock the 'Generate' button.";
        
        takeSelfieBtn.style.display = 'none';
        
        updateTryOnButtonVisibility(); 
    }
    
    // Try On button logic 
    tryOnBtn.addEventListener('click', async () => {
        if (!capturedImageBase64 || !selectedPrompt) {
            statusMessage.textContent = "Please capture a selfie and select a hairstyle first.";
            return;
        }

        tryOnBtn.disabled = true;
        tryOnBtn.style.display = 'none';
        spinner.style.display = 'block';
        statusMessage.textContent = "Processing your new look... This may take a moment.";
        
        // Build the prompt conditionally
        const complexionClause = selectedComplexion 
            ? ` with a ${selectedComplexion} complexion` 
            : ``; 
            
        // üí° NEW, AGGRESSIVE AR-STYLE PROMPT FOR MAX CONTROL:
        // Use the image as a strict mask, focusing ONLY on the hair change.
        const finalPrompt = `STRICTLY use the provided image as the input mask. DO NOT change the background, the clothing, or the subject's face/identity. ONLY apply a new hairstyle: ${selectedPrompt}. The final result must be a high quality, professional studio portrait of a ${selectedGender} model${complexionClause} with NO other changes to the original image besides the hair.`;
        
        try {
            const response = await fetch('/api/run_model', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    // Corrected key for tryon.mjs
                    baseImage: capturedImageBase64, 
                    prompt: finalPrompt,
                    negativePrompt: NEGATIVE_PROMPT 
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
            }

            const data = await response.json();
            
            // --- SUCCESS BLOCK ---
            aiResultImg.src = `data:image/jpeg;base64,${data.generatedImageBase64}`;
            aiResultImg.style.display = 'block';
            videoFeed.style.display = 'none';
            
            statusMessage.textContent = `Success! Your new look is ready. Click the Play button to start a new session.`;
            
            takeSelfieBtn.style.display = 'block'; 
            takeSelfieBtn.textContent = "‚ñ∂Ô∏è"; 
            
            spinner.style.display = 'none'; 
            tryOnBtn.style.display = 'none';
            
        } catch (error) {
            // --- ERROR BLOCK ---
            console.error('AI Processing Error:', error);
            statusMessage.textContent = `Error during AI try-on: ${error.message}. Please try again.`;
            
            tryOnBtn.disabled = false; 
            tryOnBtn.style.display = 'block'; 
            spinner.style.display = 'none'; 
            takeSelfieBtn.style.display = 'none'; 
        }
    });


    // --- INITIALIZATION and EVENT LISTENERS ---

    // Set initial gender selection
    if (maleGenderBtn) {
        handleGenderSelect('Male');
    }
    
    // Event listeners
    if (maleGenderBtn) {
        maleGenderBtn.addEventListener('click', () => handleGenderSelect('Male'));
    }

    if (femaleGenderBtn) {
        femaleGenderBtn.addEventListener('click', () => handleGenderSelect('Female'));
    }

    if (complexionSelector) {
        complexionSelector.querySelector('h3').addEventListener('click', () => toggleFilterSection(complexionSelector));
    }
    if (galleryContainer) {
        galleryContainer.querySelector('h3').addEventListener('click', () => toggleFilterSection(galleryContainer));
    }

    if (complexionGroup) {
        complexionGroup.querySelectorAll('.complexion-tile').forEach(tile => {
            tile.addEventListener('click', () => handleComplexionSelect(tile));
        });
    }

    if (galleryContainer) {
        galleryContainer.querySelectorAll('.style-option').forEach(option => {
            option.addEventListener('click', () => handleStyleSelect(option));
        });
    }

    takeSelfieBtn.addEventListener('click', () => {
        if (!cameraStarted) {
            startCamera();
        } else {
            captureImage();
        }
    });

    // Initial state setup 
    if (complexionSelector) complexionSelector.classList.add('collapsed');
    if (galleryContainer) galleryContainer.classList.add('expanded');
    
    takeSelfieBtn.textContent = "‚ñ∂Ô∏è";
    spinner.style.display = 'none';
    centralViewport.classList.add('active'); 
});
    </script>
</body>
</html>
