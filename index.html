<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hairstyle Virtual Try-On</title>
    
    <style>
/* --- Global Colors --- */
:root {
    --primary-color: #1D2124; 
    --text-on-dark: #FFFFFF; 
    --background-color: #f4f7f6;
    --text-color: #333; 
    --highlight-color: #28a745; 
    --thumbnail-size: 60px;
    --gallery-gap: 10px; 
    --header-height: 40px;
    --viewport-size-desktop: 300px; 
    --viewport-size-mobile: 250px; 
    --content-max-width: 400px; 
}

body {
    font-family: Arial, sans-serif;
    background-color: var(--background-color);
    color: var(--text-color);
    margin: 0;
    padding: 0; 
    text-align: center;
    -webkit-user-select: none;
    user-select: none;
    overflow-x: hidden; 
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

/* --- Header and Logo Styling (MINIMAL BANNER) --- */
#app-header {
    padding: 0; 
    background-color: #FFFFFF;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); 
    height: var(--header-height); 
    display: flex;
    align-items: center;
    justify-content: center;
    position: sticky; 
    top: 0;
    z-index: 100;
}
#main-logo {
    max-width: 100px !important; 
    height: 35px !important; 
    object-fit: contain; 
}

/* ================================================== */
/* NEW SINGLE-COLUMN LAYOUT */
/* ================================================== */

#main-app-container {
    flex-grow: 1; 
    width: 100%;
    padding: 20px 0;
    margin: 0 auto; 
    display: flex;
    flex-direction: column;
    align-items: center; 
    gap: 15px; /* Reduced gap for tighter layout */
}

/* --- 1. GENDER BUTTONS (Top Section) --- */
.gender-buttons-container {
    display: flex;
    justify-content: space-between;
    gap: 8px;
    width: 90%; 
    max-width: var(--content-max-width);
    margin-bottom: 0;
    box-sizing: border-box;
    padding: 0 10px;
}

.gender-button {
    flex-grow: 1;
    padding: 10px 15px;
    border: 1px solid #ccc;
    background-color: #f9f9f9;
    color: var(--text-color);
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9em;
    font-weight: bold;
    text-align: center;
    transition: all 0.2s;
    user-select: none;
    line-height: 1;
}

.gender-button:hover {
    background-color: #f0f0f0;
}

.gender-button.selected {
    background-color: var(--primary-color);
    color: var(--text-on-dark);
    border-color: var(--primary-color);
}


/* --- 2. CAMERA SECTION (Middle Section) --- */

#central-section {
    width: 90%;
    max-width: var(--content-max-width);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 15px;
    padding: 0 10px;
}

#central-viewport {
    position: relative; 
    width: var(--viewport-size-mobile) !important; 
    height: var(--viewport-size-mobile) !important;
    max-width: var(--viewport-size-desktop) !important; 
    max-height: var(--viewport-size-desktop) !important;
    margin: 0; 
    border-radius: 6px; 
    overflow: hidden;
    background-color: #e0e0e0; 
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
    
    display: flex; 
    align-items: center;
    justify-content: center;
    cursor: pointer; 
}

/* --- PURE CSS CAMERA ICON STYLES --- */

#camera-placeholder-icon {
    position: relative;
    width: 60%; 
    height: 45%; 
    background-color: #333; /* Dark body */
    border-radius: 6px;
    border: 8px solid #555; /* Frame */
    box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
}

/* The top prism/viewfinder element using ::before */
#camera-placeholder-icon::before {
    content: '';
    position: absolute;
    top: -16px; 
    left: 50%;
    transform: translateX(-50%);
    width: 30%;
    height: 10px; 
    background-color: #333;
    border-radius: 4px 4px 0 0; 
}

/* The lens element using a span */
.icon-lens {
    width: 50%;
    height: 80%;
    background-color: #fff;
    border-radius: 50%;
    border: 5px solid #000;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* The inner lens circle/iris */
.icon-lens::before {
    content: '';
    width: 50%;
    height: 50%;
    background-color: #555;
    border-radius: 50%;
    border: 3px solid #000;
}

/* --- End Pure CSS Camera Icon Styles --- */


/* Ensure video and result images fill the viewport */
#video-feed, #ai-result {
    width: 100% !important;
    height: 100% !important; 
    display: block;
    object-fit: cover !important; 
    max-width: 100% !important;
    max-height: 100% !important;
    z-index: 1; 
    /* Initially hidden */
    display: none; 
}

#status-message {
    position: absolute;
    bottom: 0;
    width: 100%;
    background: rgba(0, 0, 0, 0.6);
    color: white;
    padding: 8px 5px;
    margin: 0;
    font-size: 0.85em;
    text-align: center;
    z-index: 100; 
}

#controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-width: 400px;
}

.main-action-btn {
    margin-bottom: 10px;
    cursor: pointer;
    border: none;
    font-size: 16px; 
    transition: all 0.2s;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); 
}

/* --- MODIFIED: SHRINK CAMERA BUTTON --- */
#take-selfie-btn {
    width: 50px; /* Reduced from 70px */
    height: 50px; /* Reduced from 70px */
    padding: 0;
    border-radius: 50%; 
    background-color: var(--primary-color);
    color: var(--text-on-dark);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px; /* Reduced icon size */
    line-height: 1;
}

/* Try On Hairstyle Button Styling */
#try-on-btn {
    width: 90%; 
    max-width: var(--content-max-width);
    padding: 12px 24px;
    border-radius: 8px;
    background-color: var(--highlight-color); 
    color: var(--text-on-dark);
    font-size: 1.1em;
    font-weight: bold;
    box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
    margin-top: 5px; 
    margin-bottom: 10px;
}

/* --- 3. FILTER SECTION (Now individual sections) --- */

.filter-section {
    width: 90%; 
    max-width: var(--content-max-width);
    margin: 0 auto; /* Center the filter sections */
    padding: 0;
    background-color: #fff;
    border-radius: 6px;
    text-align: left; 
}

/* Accordion Button/Header Style */
.filter-section h3 {
    font-size: 0.9em; 
    font-weight: bold;
    margin: 0; 
    padding: 8px 10px;
    text-transform: uppercase;
    display: flex;
    justify-content: space-between; 
    align-items: center;
    cursor: pointer;
    background-color: #fff;
    border-radius: 6px;
    transition: all 0.2s ease-in-out;
}

/* --- COLLAPSED (Pill Appearance) --- */
.filter-section.collapsed h3 {
    background-color: #f0f0f0; 
    color: #666;
    border-radius: 20px; 
    height: 40px; 
    width: 90%; 
    max-width: 100%; 
    padding: 0 10px; 
    justify-content: center;
    overflow: hidden; 
    margin: 0 auto; 
}

.filter-section.collapsed h3 span {
    display: inline;
    font-size: 1.0em; 
    line-height: 40px; 
}

.filter-section.collapsed h3::after {
    content: none;
}

/* --- EXPANDED (Active Pill/Block Appearance) --- */
.filter-section.expanded h3 {
    background-color: var(--primary-color); 
    color: var(--text-on-dark);
    border-radius: 6px 6px 0 0; 
    height: auto;
    width: 100%;
    padding: 8px 10px;
    margin: 0;
    justify-content: space-between; 
}

.filter-section h3::after {
    content: 'â–¶'; 
    font-size: 0.8em;
    margin-left: 5px;
    transition: transform 0.2s;
    line-height: 1;
}

.filter-section.expanded h3::after {
    content: 'â–¼'; 
    color: var(--text-on-dark);
}

.filter-content-group {
    padding: 5px 10px 10px 10px;
    background-color: #f9f9f9;
    border-radius: 0 0 6px 6px;
}

.filter-section.collapsed .filter-content-group {
    display: none;
}


/* Filter options group */
.filter-options-group {
    display: flex;
    flex-wrap: wrap; 
    gap: 8px; 
    justify-content: flex-start; 
    margin-top: 5px; 
}

/* Complexion Tiles (Circular & Compact) */
#complexion-options-group {
    justify-content: flex-start; 
    gap: 6px; 
}

.complexion-tile {
    width: 30px; 
    height: 30px; 
    border: 2px solid transparent; 
    flex-shrink: 0; 
    border-radius: 50%;
}

.complexion-tile p {
    display: none; 
}

.complexion-tile.selected {
    border-color: var(--highlight-color);
    box-shadow: 0 0 5px rgba(40, 167, 69, 0.5); 
}

/* --- Hairstyle Gallery (INSPIRATION) --- */
#hairstyle-gallery {
    padding: 0;
    margin-bottom: 5px; 
}
#hairstyle-gallery .filter-content-group {
     padding: 10px 5px; 
}
/* Horizontal Scroll Fix */
#hairstyle-gallery .filter-options-group {
    display: flex; 
    flex-wrap: nowrap; 
    white-space: nowrap; 
    overflow-x: scroll; 
    overflow-y: hidden; 
    scroll-snap-type: x mandatory;
    gap: 8px;
    padding-bottom: 5px; 
    padding-left: 5px;
    padding-right: 5px;
}

.style-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    /* MODIFIED: Increased width for larger image */
    width: 85px; 
    flex-shrink: 0;
    border: 2px solid transparent; 
    transition: all 0.3s ease-out; 
    cursor: pointer;
}

.style-option.selected {
    border-color: var(--highlight-color);
    border-radius: 10px; /* Slightly adjusted to look good with circle */
    box-shadow: 0 0 10px rgba(40, 167, 69, 0.7); 
    transform: scale(1.1); /* Slightly smaller enlargement effect */
    z-index: 10; 
}

/* --- MODIFIED: LARGER, CIRCULAR THUMBNAILS --- */
.style-thumbnail {
    width: 80px; /* Increased size from 65px */
    height: 80px; /* Increased size from 65px */
    border-radius: 50%; /* Made circular */
    object-fit: cover;
    margin-bottom: 4px; /* Space between image and text */
}

.style-option p {
    font-size: 0.75em;
    white-space: normal;
    word-break: break-word;
    margin: 4px 0 0 0;
}

/* ================================================== */
/* ðŸ“± MOBILE MEDIA QUERY OPTIMIZATIONS */
/* ================================================== */

@media (max-width: 600px) {
    
    #main-app-container {
        padding: 10px 0;
        gap: 15px; 
    }
    
    .gender-buttons-container,
    #central-section,
    .filter-section,
    #try-on-btn {
        width: 95%; 
        max-width: 95%;
        box-sizing: border-box;
        padding: 0 10px;
    }
    
    #central-viewport {
        width: 80vw !important; 
        height: 80vw !important;
        max-width: 300px !important; 
        max-height: 300px !important;
    }
    
    .filter-section.collapsed h3 {
        width: 95%; 
    }

    #complexion-options-group {
        justify-content: space-around;
        flex-wrap: nowrap;
        overflow-x: scroll;
        padding-bottom: 5px;
        padding-top: 5px;
        scroll-snap-type: x mandatory;
    }

    .complexion-tile {
        width: 40px; 
        height: 40px; 
        flex-shrink: 0;
        position: relative;
    }
    .complexion-tile p {
        display: block; 
        font-size: 0.6em;
        position: absolute;
        top: 100%; 
        left: 50%;
        transform: translateX(-50%);
        margin-top: 5px; 
        width: 60px;
    }
    
    #hairstyle-gallery .filter-options-group {
        padding-left: 10px;
        padding-right: 10px;
    }
    
    .style-option {
        /* MODIFIED: Larger mobile option width */
        width: 85px; 
        flex-shrink: 0;
    }
    .style-thumbnail {
        /* MODIFIED: Larger mobile thumbnail size */
        width: 80px; 
        height: 80px; 
    }

    .style-option p {
        font-size: 0.8em;
    }
}
    </style>
</head>
<body>
    <div id="app-header">
        <img id="main-logo" src="assets/Minimalist 'Looks' Logo with Hair Strand Design (1).png" alt="Looks Logo">
    </div>

    <div id="main-app-container">
        
        <div class="gender-buttons-container">
            <button id="male-gender-btn" class="gender-button">Male</button>
            <button id="female-gender-btn" class="gender-button">Female</button>
        </div>
        
        <div id="hairstyle-gallery" class="filter-section expanded">
            <h3><span>Hairstyle Inspiration</span><span class="icon"></span></h3>
            <div class="filter-content-group">
                <div class="filter-options-group">
                    
                    <div class="style-option" data-prompt="a slicked-back undercut with brushed up blonde hair">
                        <img class="style-thumbnail" src="styles/brushed up blonde.jpeg" alt="Brushed Up Blonde">
                        <p>Brushed Up Blonde</p>
                    </div>
                    
                    <div class="style-option" data-prompt="a short cut with a heavy forward fringe">
                        <img class="style-thumbnail" src="styles/forward fringe.jpeg" alt="Forward Fringe">
                        <p>Forward Fringe</p>
                    </div>
                    
                    <div class="style-option" data-prompt="a classic high top fade with sharp lines">
                        <img class="style-thumbnail" src="styles/high top fade.jpeg" alt="High Top Fade">
                        <p>High Top Fade</p>
                    </div>
                    
                    <div class="style-option" data-prompt="a voluminous hairstyle with natural curls">
                        <img class="style-thumbnail" src="styles/natural curls.jpeg" alt="Natural Curls">
                        <p>Natural Curls</p>
                    </div>
                    
                    <div class="style-option" data-prompt="a clean side swept scissor cut">
                        <img class="style-thumbnail" src="styles/side swept scissor cut.jpeg" alt="Side Swept Scissor Cut">
                        <p>Side Swept Scissor Cut</p>
                    </div>
                    
                    <div class="style-option" data-prompt="a sleek, formal side part style">
                        <img class="style-thumbnail" src="styles/sleek side part.jpeg" alt="Sleek Side Part">
                        <p>Sleek Side Part</p>
                    </div>
                    
                    <div class="style-option" data-prompt="a fun, short spiked hairstyle">
                        <img class="style-thumbnail" src="styles/spiked charm.jpeg" alt="Spiked Charm">
                        <p>Spiked Charm</p>
                    </div>
                    
                    <div class="style-option" data-prompt="a short haircut with a tousled and textured top">
                        <img class="style-thumbnail" src="styles/tousled top.jpeg" alt="Tousled Top">
                        <p>Tousled Top</p>
                    </div>
                    
                    <div class="style-option" data-prompt="a modern wavy quiff with volume">
                        <img class="style-thumbnail" src="styles/wavy quiff.jpeg" alt="Wavy Quiff">
                        <p>Wavy Quiff</p>
                    </div>
                    
                </div>
            </div>
        </div>


        <div id="central-section">
            <div id="central-viewport">
                <div id="camera-placeholder-icon">
                    <span class="icon-lens"></span>
                </div>
                
                <video id="video-feed" autoplay playsinline></video>
                <img id="ai-result" style="display: none;" src="" alt="AI Hairstyle Result">
                <p id="status-message">Tap the camera icon above to start your live feed.</p>
            </div>
            
            <div id="controls">
                <button id="take-selfie-btn" class="main-action-btn">ðŸ“¸</button>
                <div id="loading-spinner" class="spinner"></div>
            </div>
        </div>

        <button id="try-on-btn" class="main-action-btn" style="display: none;">Generate My New Look</button>


        <div id="complexion-selector" class="filter-section collapsed">
            <h3><span>Complexion (Optional)</span><span class="icon"></span></h3>
            <div class="filter-content-group">
                <div id="complexion-options-group" class="filter-options-group">
                    <div class="complexion-tile" style="background-color: #F8D7BE;" data-complexion="Light"></div>
                    <div class="complexion-tile" style="background-color: #D6A476;" data-complexion="Medium"></div>
                    <div class="complexion-tile" style="background-color: #A97A52;" data-complexion="Dark"></div>
                    <div class="complexion-tile" style="background-color: #6A3E26;" data-complexion="Deep"></div>
                </div>
            </div>
        </div>

    </div> <canvas id="hidden-canvas" style="display: none;"></canvas>

    <script>
document.addEventListener('DOMContentLoaded', () => {
    // 1. Get DOM elements
    const videoFeed = document.getElementById('video-feed');
    const aiResultImg = document.getElementById('ai-result');
    const canvas = document.getElementById('hidden-canvas');

    // Placeholder Icon element
    const cameraPlaceholderIcon = document.getElementById('camera-placeholder-icon');

    // Buttons and Controls
    const takeSelfieBtn = document.getElementById('take-selfie-btn');
    const tryOnBtn = document.getElementById('try-on-btn');
    const spinner = document.getElementById('loading-spinner');

    const statusMessage = document.getElementById('status-message');

    // Filter elements
    const complexionSelector = document.getElementById('complexion-selector');
    const complexionGroup = document.getElementById('complexion-options-group');
    const galleryContainer = document.getElementById('hairstyle-gallery');

    // New Gender Buttons
    const maleGenderBtn = document.getElementById('male-gender-btn');
    const femaleGenderBtn = document.getElementById('female-gender-btn');

    // State tracking variables
    let capturedImageBase64 = null;
    let selectedPrompt = null;
    let cameraStarted = false;
    let selectedGender = 'Male';
    let selectedComplexion = null;
    let imageCaptured = false;

    // --- CONSTANTS ---
    const NEGATIVE_PROMPT = "extra fingers, blurry, low resolution, bad hands, deformed face, mask artifact, bad blending, unnatural hair hair color, ugly, tiling, duplicate, abstract, cartoon, distorted pupils, bad lighting, cropped, grainy, noise, poor lighting, poor composition, low quality, changed clothing, changed background, new outfit, new background, different lighting";

    // --- Helper Functions ---

    function updateTryOnButtonVisibility() {
        // Only show 'Try On' if an image is captured AND a style is selected
        if (imageCaptured && selectedPrompt) {
            tryOnBtn.style.display = 'block';
            tryOnBtn.disabled = false;
            if (!statusMessage.textContent.includes('Processing')) {
                 const complexionStatus = selectedComplexion ? `(${selectedComplexion} Complexion selected)` : '(Complexion Auto-Detected)';
                 statusMessage.textContent = `All set! Click 'Generate My New Look' below ${complexionStatus}.`;
            }
        } else {
            tryOnBtn.style.display = 'none';
        }
    }

    function handleGenderSelect(gender) {
        selectedGender = gender;
        maleGenderBtn.classList.remove('selected');
        femaleGenderBtn.classList.remove('selected');
        if (gender === 'Male') {
            maleGenderBtn.classList.add('selected');
        } else if (gender === 'Female') {
            femaleGenderBtn.classList.add('selected');
        }
        updateTryOnButtonVisibility();
    }

    function toggleFilterSection(section) {
        if (section.classList.contains('collapsed')) {
            section.classList.remove('collapsed');
            section.classList.add('expanded');
        } else {
            section.classList.remove('expanded');
            section.classList.add('collapsed');
        }
    }

    function handleComplexionSelect(tile) {
        const isSelected = tile.classList.contains('selected');
        const complexionTiles = complexionGroup.querySelectorAll('.complexion-tile');

        complexionTiles.forEach(t => t.classList.remove('selected'));

        if (!isSelected) {
            tile.classList.add('selected');
            selectedComplexion = tile.dataset.complexion;
        } else {
            selectedComplexion = null;
        }

        updateTryOnButtonVisibility();
    }

    function handleStyleSelect(styleOption) {
        const styleOptions = galleryContainer.querySelectorAll('.style-option');

        styleOptions.forEach(o => {
            o.classList.remove('selected');
            o.style.transform = '';
        });

        styleOption.classList.add('selected');
        selectedPrompt = styleOption.dataset.prompt;

        updateTryOnButtonVisibility();

        if (imageCaptured) {
             statusMessage.textContent = `Style selected. Click 'Generate' or select a complexion (optional).`;
        }
    }


    // --- CRITICAL FIX: startCamera Function with Promise for Stream Loading ---
    async function startCamera() {
        if (cameraStarted) return; 

        // 1. Temporarily change the status message to indicate loading
        statusMessage.textContent = "Requesting camera access...";

        try {
            const constraints = {
                video: {
                    facingMode: 'user', // Requesting the front camera
                    width: { ideal: 250 },
                    height: { ideal: 250 }
                }
            };
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            
            // 2. Success: Attach the stream to the video element
            videoFeed.srcObject = stream;
            
            // Wait for the video element to load the stream metadata before continuing
            await new Promise(resolve => {
                videoFeed.onloadedmetadata = () => {
                    videoFeed.play();
                    resolve();
                };
            });

            cameraStarted = true;
            imageCaptured = false;

            // 3. Update visibility: Show video, hide icon
            cameraPlaceholderIcon.style.display = 'none'; 
            aiResultImg.style.display = 'none';
            videoFeed.style.display = 'block'; 

            // 4. Update Controls
            takeSelfieBtn.textContent = "ðŸ“¸";
            takeSelfieBtn.disabled = false;
            tryOnBtn.style.display = 'none';

            statusMessage.textContent = "Adjust your face in the box, then click ðŸ“¸ to capture.";

        } catch (error) {
            // 5. Error Handling: Revert state and display error
            console.error('Error accessing camera:', error);

            // Revert status and button
            statusMessage.textContent = `Error: Cannot start camera. Check permissions/device settings. (${error.name})`;
            takeSelfieBtn.textContent = "ðŸ“¸";
            takeSelfieBtn.disabled = true; 
            
            // Ensure the placeholder remains visible if the camera failed to start
            cameraPlaceholderIcon.style.display = 'block';
            videoFeed.style.display = 'none';
            
            cameraStarted = false;
        }
    }

    function stopCamera() {
        if (videoFeed.srcObject) {
            videoFeed.srcObject.getTracks().forEach(track => track.stop());
            videoFeed.srcObject = null;
        }
        cameraStarted = false;
    }

    function captureImage() {
        const context = canvas.getContext('2d');
        const width = videoFeed.videoWidth || 250; 
        const height = videoFeed.videoHeight || 250;

        canvas.width = width;
        canvas.height = height;
        
        // Draw image from the video frame
        context.drawImage(videoFeed, 0, 0, width, height);

        const fullDataURL = canvas.toDataURL('image/jpeg');

        const parts = fullDataURL.split(',');
        capturedImageBase64 = parts.length > 1 ? parts[1] : fullDataURL;

        imageCaptured = true;

        videoFeed.style.display = 'none';
        aiResultImg.style.display = 'block';
        aiResultImg.src = fullDataURL; 

        stopCamera();

        statusMessage.textContent = "Image captured. Select a hairstyle to unlock the 'Generate' button.";

        takeSelfieBtn.textContent = "â–¶ï¸"; // Button now means "Start New Session"

        updateTryOnButtonVisibility();
    }

    // Logic for handling the main action button (Capture/Restart)
    takeSelfieBtn.addEventListener('click', () => {
        if (cameraStarted) {
            captureImage();
        } 
        else if (imageCaptured) {
            // Restart Session:
            aiResultImg.style.display = 'none';
            cameraPlaceholderIcon.style.display = 'block';
            imageCaptured = false;
            capturedImageBase64 = null;

            takeSelfieBtn.textContent = "ðŸ“¸";
            takeSelfieBtn.disabled = true;
            statusMessage.textContent = "Tap the camera icon above to start your live feed.";
            updateTryOnButtonVisibility();
        }
    });

    // Click listener on the placeholder icon to START the camera
    cameraPlaceholderIcon.addEventListener('click', () => {
        if (!cameraStarted && !imageCaptured) {
            startCamera();
        }
    });
    
    // Try On button logic (remains the same)
    tryOnBtn.addEventListener('click', async () => {
        if (!capturedImageBase64 || !selectedPrompt) {
            statusMessage.textContent = "Please capture a selfie and select a hairstyle first.";
            return;
        }

        tryOnBtn.disabled = true;
        tryOnBtn.style.display = 'none';
        spinner.style.display = 'block';
        statusMessage.textContent = "Processing your new look... This may take a moment.";

        const complexionClause = selectedComplexion
            ? ` with a ${selectedComplexion} complexion`
            : ``;

        const finalPrompt = `STRICTLY use the provided image as the input mask. DO NOT change the background, the clothing, or the subject's face/identity. ONLY apply a new hairstyle: ${selectedPrompt}. The final result must be a high quality, professional studio portrait of a ${selectedGender} model${complexionClause} with NO other changes to the original image besides the hair.`;

        try {
            // Note: The API call assumes '/api/run_model' maps to your netlify/functions/tryon.mjs
            const response = await fetch('/api/run_model', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    baseImage: capturedImageBase64,
                    prompt: finalPrompt,
                    negativePrompt: NEGATIVE_PROMPT
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
            }

            const data = await response.json();

            // --- SUCCESS BLOCK ---
            aiResultImg.src = `data:image/jpeg;base64,${data.generatedImageBase64}`;
            aiResultImg.style.display = 'block';

            videoFeed.style.display = 'none';
            cameraPlaceholderIcon.style.display = 'none';

            statusMessage.textContent = `Success! Your new look is ready. Click the Play button to start a new session.`;

            takeSelfieBtn.style.display = 'block';
            takeSelfieBtn.textContent = "â–¶ï¸";
            takeSelfieBtn.disabled = false;

            spinner.style.display = 'none';
            tryOnBtn.style.display = 'none';

        } catch (error) {
            // --- ERROR BLOCK ---
            console.error('AI Processing Error:', error);
            statusMessage.textContent = `Error during AI try-on: ${error.message}. Please try again.`;

            tryOnBtn.disabled = false;
            tryOnBtn.style.display = 'block';
            spinner.style.display = 'none';
            takeSelfieBtn.style.display = 'none';
        }
    });


    // --- INITIALIZATION and EVENT LISTENERS ---

    // Set initial gender selection
    if (maleGenderBtn) {
        handleGenderSelect('Male');
    }

    if (maleGenderBtn) {
        maleGenderBtn.addEventListener('click', () => handleGenderSelect('Male'));
    }

    if (femaleGenderBtn) {
        femaleGenderBtn.addEventListener('click', () => handleGenderSelect('Female'));
    }

    if (complexionSelector) {
        complexionSelector.querySelector('h3').addEventListener('click', () => toggleFilterSection(complexionSelector));
    }
    if (galleryContainer) {
        galleryContainer.querySelector('h3').addEventListener('click', () => toggleFilterSection(galleryContainer));
    }

    if (complexionGroup) {
        complexionGroup.querySelectorAll('.complexion-tile').forEach(tile => {
            tile.addEventListener('click', () => handleComplexionSelect(tile));
        });
    }

    if (galleryContainer) {
        galleryContainer.querySelectorAll('.style-option').forEach(option => {
            option.addEventListener('click', () => handleStyleSelect(option));
        });
    }

    // Initial filter state (Gallery expanded, Complexion collapsed)
    if (complexionSelector) complexionSelector.classList.add('collapsed');
    if (galleryContainer) galleryContainer.classList.add('expanded');

    // Initial button state
    takeSelfieBtn.textContent = "ðŸ“¸";
    takeSelfieBtn.disabled = true; 
    spinner.style.display = 'none';
});
    </script>
</body>
</html>
